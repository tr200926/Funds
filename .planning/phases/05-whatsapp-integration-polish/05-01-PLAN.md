---
phase: 05-whatsapp-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260213000001_whatsapp_channel_support.sql
  - supabase/functions/_shared/notification-formatters.ts
  - supabase/functions/dispatch-notifications/index.ts
autonomous: true

user_setup:
  - service: whatsapp-cloud-api
    why: "Send approved WhatsApp template alerts from dispatch-notifications"
    env_vars:
      - name: WHATSAPP_ACCESS_TOKEN
        source: "Meta Business Manager → Business Settings → Users → System Users → Generate Token (whatsapp_business_messaging + whatsapp_business_management)"
      - name: WHATSAPP_PHONE_NUMBER_ID
        source: "Meta Business Suite → WhatsApp Manager → Phone Numbers → copy Phone Number ID"
    dashboard_config:
      - task: "Register a dedicated WhatsApp Business number (not tied to WhatsApp App)"
        location: "Meta Business Suite → WhatsApp Manager → Getting Started"
      - task: "Submit balance_warning, critical_alert, daily_summary templates (UTILITY category)"
        location: "Meta Business Suite → WhatsApp Manager → Message Templates"
      - task: "Generate permanent System User access token (temporary tokens expire in 24h)"
        location: "Meta Business Manager → Users → System Users"
      - task: "Set Edge Function secrets"
        location: "Terminal: npx supabase secrets set WHATSAPP_ACCESS_TOKEN=... WHATSAPP_PHONE_NUMBER_ID=..."

must_haves:
  truths:
    - "dispatch-notifications sends WhatsApp template messages whenever channel_type==='whatsapp'"
    - "Each WhatsApp delivery logs to alert_deliveries with status, response_data, and error message"
    - "Profiles without whatsapp_opt_in=true are skipped automatically during dispatch"
    - "Notification channel configuration is constrained to email/telegram/whatsapp/webhook"
  artifacts:
    - path: "supabase/migrations/20260213000001_whatsapp_channel_support.sql"
      provides: "Constraint + defaults enforcing WhatsApp-ready schema"
      contains: "notification_channels_channel_type_check"
    - path: "supabase/functions/_shared/notification-formatters.ts"
      provides: "formatAlertWhatsAppParams helper with template selection logic"
      contains: "formatAlertWhatsAppParams"
    - path: "supabase/functions/dispatch-notifications/index.ts"
      provides: "sendWhatsApp helper + whatsapp case in dispatch loop"
      contains: "sendWhatsApp"
  key_links:
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "WhatsApp Cloud API"
      via: "fetch POST https://graph.facebook.com/v23.0/{PHONE_NUMBER_ID}/messages"
      pattern: "graph\\.facebook\\.com/.*/messages"
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "profiles"
      via: "settings->>'whatsapp_opt_in' lookup before sending"
      pattern: "from\\('profiles'\).*(settings|whatsapp_opt_in)"
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "supabase/functions/_shared/notification-formatters.ts"
      via: "formatAlertWhatsAppParams import for template params"
      pattern: "formatAlertWhatsAppParams"
---

<objective>
Extend the alert engine backend so WhatsApp is a first-class notification channel: schema guardrails, template parameter formatter, and dispatch-notifications wiring to the WhatsApp Cloud API.

Purpose: R6.1 requires WhatsApp delivery before the dashboard work can configure channels. This plan adds the backend foundation so later plans only focus on UI and verification.
Output: SQL migration for constraints/defaults, new formatter helper, updated dispatch-notifications Edge Function with sendWhatsApp implementation.
</objective>

<execution_context>
@C:/Users/hossa/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/04-alert-engine-email-telegram/04-01-SUMMARY.md
@supabase/functions/_shared/types.ts
@supabase/functions/_shared/constants.ts
@supabase/functions/_shared/notification-formatters.ts
@supabase/functions/dispatch-notifications/index.ts
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WhatsApp-safe schema guardrails</name>
  <files>supabase/migrations/20260213000001_whatsapp_channel_support.sql</files>
  <action>
Create a timestamped SQL migration (reuse the committed filename) that makes the database WhatsApp-ready without introducing new tables.

1. **Lock channel types** – wrap `ALTER TABLE ... ADD CONSTRAINT notification_channels_channel_type_check CHECK (channel_type IN ('email','telegram','whatsapp','webhook'))` inside `DO $$` so reruns are safe.
2. **Document + default profile settings** – ensure `profiles.settings` column has `DEFAULT '{}'::jsonb` and add a column comment describing the WhatsApp opt-in fields (opt_in boolean, phone E.164, opted_in_at ISO timestamp).
3. **Partial index for lookups** – create `idx_profiles_whatsapp_opt_in` filtered on opted-in users to speed up dispatch queries. Use `CREATE INDEX IF NOT EXISTS`.
4. **Wrap in BEGIN/COMMIT** and keep statements idempotent (`IF NOT EXISTS` guards) so `npx supabase db push` can reapply cleanly.

Call out in the migration header that the Supabase CLI must be invoked via `npx supabase` per project decision.
  </action>
  <verify>
- Migration file exists and wraps work in BEGIN/COMMIT
- Constraint name `notification_channels_channel_type_check` present with WhatsApp in allowed values
- Column comment and default for `profiles.settings` defined
- Filtered index definition present with `IF NOT EXISTS`
- Migration touches only existing tables
  </verify>
  <done>
Schema enforces WhatsApp as a valid channel, documents JSONB opt-in fields, and exposes an index for opted-in profiles without creating new tables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement WhatsApp formatter and dispatch case</name>
  <files>
supabase/functions/_shared/notification-formatters.ts
supabase/functions/dispatch-notifications/index.ts
  </files>
  <action>
Update the shared formatter module plus dispatch-notifications Edge Function to send approved WhatsApp templates.

**Formatter helper**
- Append a documented `formatAlertWhatsAppParams(alert: AlertWithDetails)` export returning `{ templateName, params }`.
- Map `critical`/`emergency` severities to the `critical_alert` template with `[accountName, alert.message, balanceString, cairoTimestamp]`.
- Default to `balance_warning` template with projections derived from `context_data.days_remaining`.
- Use Cairo timezone via `toLocaleString` and coerce NUMERIC string fields with `Number()` before formatting.

**dispatch-notifications updates**
- Import the new helper and add a `sendWhatsApp` function that fetches `WHATSAPP_ACCESS_TOKEN` + `WHATSAPP_PHONE_NUMBER_ID` via `Deno.env.get`, then POSTs to `https://graph.facebook.com/v23.0/${phoneNumberId}/messages` using template payloads generated by the formatter.
- Inside the channel loop, add `else if (channel.channel_type === 'whatsapp')`:
  - Treat `channel.config.recipients` as Array<{ phone: string; user_id: string }>.
  - Fetch each recipient's profile settings and skip if `whatsapp_opt_in` is falsy (WhatsApp Business policy).
  - Call `sendWhatsApp` for opted-in users and insert one row per recipient into `alert_deliveries` capturing `status`, `response_data`, `error_message`, and `sent_at`.
  - Guard each send with try/catch so a failed number does not block others.
- Leave existing email/telegram branches untouched besides the new import.

Reference Graph API v23.0 explicitly to match the Facebook ingestion decision from Phase 2.
  </action>
  <verify>
- notification-formatters.ts exports `formatAlertWhatsAppParams` with documented template selection logic
- dispatch-notifications defines `sendWhatsApp` hitting the v23.0 Graph API endpoint and reading env secrets
- WhatsApp case enforces per-user opt-in and logs deliveries
- Existing email/telegram code paths remain unchanged
  </verify>
  <done>
Shared formatter chooses the correct template/params and dispatch-notifications now handles whatsapp channels via the Graph API while enforcing per-user opt-in and logging alert deliveries.
  </done>
</task>

</tasks>

<verification>
- `npx supabase db lint` over the new migration passes
- `npx supabase functions deploy dispatch-notifications` succeeds with the WhatsApp additions
- alert_deliveries rows show `channel_type='whatsapp'` with response metadata during local tests
- Graph API requests target v23.0 and reuse the existing fetch-based dispatch pattern
</verification>

<success_criteria>
- Database enforces supported channel types and documents WhatsApp opt-in fields
- dispatch-notifications formats WhatsApp templates and posts to Graph API v23.0 with env secrets
- Users lacking whatsapp_opt_in are never contacted
- Every WhatsApp send inserts an alert_deliveries row with accurate metadata
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md`
</output>
