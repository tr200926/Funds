---
phase: 05-whatsapp-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260213000001_whatsapp_channel_support.sql
  - supabase/functions/_shared/notification-formatters.ts
  - supabase/functions/dispatch-notifications/index.ts
autonomous: true

user_setup:
  - service: whatsapp-cloud-api
    why: "WhatsApp Business Platform access for sending template messages"
    env_vars:
      - name: WHATSAPP_ACCESS_TOKEN
        source: "Meta Business Manager -> Business Settings -> Users -> System Users -> Generate Token (permissions: whatsapp_business_messaging, whatsapp_business_management)"
      - name: WHATSAPP_PHONE_NUMBER_ID
        source: "Meta Business Manager -> WhatsApp Manager -> Phone Numbers -> copy Phone Number ID"
    dashboard_config:
      - task: "Register a dedicated WhatsApp Business phone number (must NOT be registered with any personal WhatsApp or WhatsApp Business App)"
        location: "Meta Business Suite -> WhatsApp Manager -> Getting Started"
      - task: "Submit 3 message templates for approval BEFORE deploying code (balance_warning, critical_alert, daily_summary) as UTILITY category"
        location: "Meta Business Suite -> WhatsApp Manager -> Message Templates -> Create Template"
      - task: "Generate permanent System User access token (NOT the temporary 24-hour token from the dashboard)"
        location: "Meta Business Manager -> Business Settings -> Users -> System Users -> Add -> Generate Token"
      - task: "Set Edge Function secrets for WhatsApp credentials"
        location: "Terminal: npx supabase secrets set WHATSAPP_ACCESS_TOKEN=EAA... WHATSAPP_PHONE_NUMBER_ID=123456789012345"

must_haves:
  truths:
    - "dispatch-notifications Edge Function sends WhatsApp template messages when channel_type is 'whatsapp'"
    - "WhatsApp messages use pre-approved template names (balance_warning, critical_alert) with parameterized body components"
    - "Per-user opt-in is verified before every WhatsApp dispatch -- users without whatsapp_opt_in=true are skipped"
    - "WhatsApp deliveries are logged to alert_deliveries with channel_type='whatsapp', status, and response data"
    - "notification_channels table has a CHECK constraint ensuring only valid channel_type values"
  artifacts:
    - path: "supabase/migrations/20260213000001_whatsapp_channel_support.sql"
      provides: "CHECK constraint on notification_channels.channel_type, default profiles.settings structure"
      contains: "channel_type IN"
    - path: "supabase/functions/_shared/notification-formatters.ts"
      provides: "formatAlertWhatsAppParams helper for template parameter generation"
      contains: "formatAlertWhatsAppParams"
    - path: "supabase/functions/dispatch-notifications/index.ts"
      provides: "WhatsApp case in channel dispatch loop with sendWhatsApp function"
      contains: "sendWhatsApp"
  key_links:
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "WhatsApp Cloud API"
      via: "fetch POST to https://graph.facebook.com/v23.0/{PHONE_NUMBER_ID}/messages"
      pattern: "graph\\.facebook\\.com.*messages"
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "supabase profiles table"
      via: "Per-user opt-in check before WhatsApp dispatch"
      pattern: "from\\('profiles'\\).*whatsapp_opt_in"
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "supabase/functions/_shared/notification-formatters.ts"
      via: "import formatAlertWhatsAppParams for template parameter building"
      pattern: "import.*formatAlertWhatsAppParams"
---

<objective>
Extend the existing alert engine backend with WhatsApp Cloud API support: database migration for channel type constraints and profile settings defaults, a WhatsApp template parameter formatter in the shared module, and the sendWhatsApp dispatch case in the dispatch-notifications Edge Function.

Purpose: This is the backend foundation for WhatsApp alerts. Without this, the dashboard UI cannot configure or send WhatsApp messages. The dispatch-notifications function already has email and telegram cases from Phase 4 -- this plan adds the third case.
Output: One SQL migration, updated notification-formatters.ts with WhatsApp helper, updated dispatch-notifications/index.ts with WhatsApp dispatch logic.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/04-alert-engine-email-telegram/04-01-SUMMARY.md
@.planning/phases/04-alert-engine-email-telegram/04-02-SUMMARY.md
@supabase/functions/_shared/types.ts
@supabase/functions/_shared/notification-formatters.ts
@supabase/functions/dispatch-notifications/index.ts
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp support database migration</name>
  <files>supabase/migrations/20260213000001_whatsapp_channel_support.sql</files>
  <action>
Create a SQL migration that adds database-level support for WhatsApp as a notification channel.

**1. Add CHECK constraint to notification_channels.channel_type:**
```sql
ALTER TABLE notification_channels
  ADD CONSTRAINT notification_channels_channel_type_check
  CHECK (channel_type IN ('email', 'telegram', 'whatsapp', 'webhook'));
```
Use `DO $$ ... END $$` block to check if constraint already exists before adding (idempotent):
```sql
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'notification_channels_channel_type_check'
  ) THEN
    ALTER TABLE notification_channels
      ADD CONSTRAINT notification_channels_channel_type_check
      CHECK (channel_type IN ('email', 'telegram', 'whatsapp', 'webhook'));
  END IF;
END $$;
```

**2. Add default profiles.settings structure comment:**
Add a SQL comment documenting the expected JSONB shape for profiles.settings with WhatsApp fields:
```sql
COMMENT ON COLUMN profiles.settings IS 'JSONB user preferences. Expected keys: whatsapp_opt_in (boolean), whatsapp_phone (E.164 string e.g. +201234567890), whatsapp_opted_in_at (ISO timestamp). Default: {}';
```

**3. Ensure profiles.settings column has a default empty JSONB:**
```sql
ALTER TABLE profiles ALTER COLUMN settings SET DEFAULT '{}'::jsonb;
```
This is safe if it already has a default -- it just overwrites.

**4. Add index for WhatsApp opt-in queries** (performance for dispatch-time profile lookups):
```sql
CREATE INDEX IF NOT EXISTS idx_profiles_whatsapp_opt_in
  ON profiles USING btree (id)
  WHERE (settings->>'whatsapp_opt_in')::boolean = true;
```

**Important:** Do NOT create any new tables. The existing notification_channels and alert_deliveries tables already support 'whatsapp' as a channel_type value. This migration only adds safety constraints and performance indexes.

Wrap the entire migration in BEGIN/COMMIT for transactional safety.
  </action>
  <verify>
- File exists at supabase/migrations/20260213000001_whatsapp_channel_support.sql
- Contains CHECK constraint for notification_channels.channel_type with 'whatsapp' in the allowed values
- Contains ALTER TABLE profiles for settings default
- Contains index creation for WhatsApp opt-in lookup
- Migration is idempotent (uses IF NOT EXISTS / DO blocks)
- No new table creation -- only constraints and indexes on existing tables
  </verify>
  <done>
SQL migration adds CHECK constraint to notification_channels.channel_type (email, telegram, whatsapp, webhook), sets profiles.settings default to empty JSONB, creates partial index for WhatsApp opt-in profile lookups. All operations are idempotent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WhatsApp formatter and extend dispatch-notifications</name>
  <files>
supabase/functions/_shared/notification-formatters.ts
supabase/functions/dispatch-notifications/index.ts
  </files>
  <action>
**Part A: Extend notification-formatters.ts**

Add a new exported function `formatAlertWhatsAppParams` to the existing notification-formatters.ts file. Do NOT replace existing formatAlertEmailHtml, formatAlertTelegramText, or isInQuietHours functions -- append to them.

```typescript
/**
 * Build ordered template parameters for WhatsApp Cloud API template messages.
 * Returns { templateName, params } where params is a string array matching
 * the {{1}}, {{2}}, ... placeholders in the approved template.
 */
export function formatAlertWhatsAppParams(
  alert: AlertWithDetails
): { templateName: string; params: string[] } {
  const accountName = alert.ad_accounts?.account_name || 'Unknown Account'
  const cairoTime = new Date().toLocaleString('en-US', {
    timeZone: 'Africa/Cairo',
    dateStyle: 'medium',
    timeStyle: 'short',
  })

  // critical_alert template: {{1}}=account, {{2}}=message, {{3}}=balance, {{4}}=time
  if (alert.severity === 'critical' || alert.severity === 'emergency') {
    const balance = alert.context_data?.balance !== undefined
      ? `${alert.ad_accounts?.currency ?? 'EGP'} ${alert.context_data.balance}`
      : 'N/A'
    return {
      templateName: 'critical_alert',
      params: [accountName, alert.message, balance, cairoTime],
    }
  }

  // balance_warning template: {{1}}=account, {{2}}=details, {{3}}=projection, {{4}}=time
  const projection = alert.context_data?.days_remaining !== undefined
    ? `Funds may deplete in ~${alert.context_data.days_remaining} days`
    : ''
  return {
    templateName: 'balance_warning',
    params: [accountName, alert.message, projection, cairoTime],
  }
}
```

Ensure the AlertWithDetails type import is already present (it should be from Phase 4). If context_data typing needs extension, add `context_data?: Record<string, unknown>` to the type usage.

**Part B: Extend dispatch-notifications/index.ts**

Add the WhatsApp dispatch case to the existing channel switch/if-else chain. This file already has 'email' and 'telegram' cases from Phase 4 Plan 02.

**Add sendWhatsApp helper function** (within the file, after sendEmail and sendTelegram):

```typescript
async function sendWhatsApp(
  alert: AlertWithDetails,
  recipientPhone: string
): Promise<DeliveryResult> {
  const accessToken = Deno.env.get('WHATSAPP_ACCESS_TOKEN')
  const phoneNumberId = Deno.env.get('WHATSAPP_PHONE_NUMBER_ID')

  if (!accessToken || !phoneNumberId) {
    return { ok: false, error: 'WhatsApp credentials not configured' }
  }

  const { templateName, params } = formatAlertWhatsAppParams(alert)

  const res = await fetch(
    `https://graph.facebook.com/v23.0/${phoneNumberId}/messages`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messaging_product: 'whatsapp',
        to: recipientPhone,
        type: 'template',
        template: {
          name: templateName,
          language: { code: 'en' },
          components: [
            {
              type: 'body',
              parameters: params.map(p => ({ type: 'text', text: p })),
            },
          ],
        },
      }),
    }
  )

  const data = await res.json()
  if (data.error) {
    return { ok: false, data, error: data.error.message || `WhatsApp API error ${res.status}` }
  }
  return { ok: true, data }
}
```

**Add the WhatsApp else-if branch** in the existing channel dispatch loop (after the telegram case):

```typescript
} else if (channel.channel_type === 'whatsapp') {
  // WhatsApp channels store recipients as array of { phone, user_id }
  const recipients = (channel.config.recipients ?? []) as Array<{
    phone: string
    user_id: string
  }>

  for (const recipient of recipients) {
    // Per-user opt-in check (R6.3) -- verify BEFORE every dispatch
    const { data: profile } = await supabase
      .from('profiles')
      .select('settings')
      .eq('id', recipient.user_id)
      .single()

    if (!profile?.settings?.whatsapp_opt_in) {
      // User has not opted in -- skip silently per WhatsApp Business Policy
      continue
    }

    try {
      const result = await sendWhatsApp(alert, recipient.phone)
      await supabase.from('alert_deliveries').insert({
        alert_id,
        channel_type: 'whatsapp',
        recipient: recipient.phone,
        status: result.ok ? 'sent' : 'failed',
        response_data: result.data,
        error_message: result.error ?? null,
        sent_at: result.ok ? new Date().toISOString() : null,
      })
    } catch (e) {
      await supabase.from('alert_deliveries').insert({
        alert_id,
        channel_type: 'whatsapp',
        recipient: recipient.phone,
        status: 'failed',
        error_message: e.message,
      })
    }
  }
}
```

**Add import** for `formatAlertWhatsAppParams` from `../_shared/notification-formatters.ts` alongside the existing formatAlertEmailHtml and formatAlertTelegramText imports.

**Important details:**
- WhatsApp uses Graph API v23.0 (same version as Facebook ingestion in Phase 2)
- Template names are stored in constants, not hardcoded in the if/else. The `formatAlertWhatsAppParams` function handles template selection.
- Per-user opt-in check queries profiles.settings.whatsapp_opt_in BEFORE every dispatch. This is a WhatsApp Business Policy requirement.
- Emergency alerts STILL bypass quiet hours (handled by the existing quiet hours check above the channel type switch -- no change needed)
- Each recipient gets a separate delivery row in alert_deliveries for tracking
  </action>
  <verify>
- notification-formatters.ts exports formatAlertWhatsAppParams alongside existing exports
- formatAlertWhatsAppParams returns { templateName, params } with correct template selection logic
- dispatch-notifications/index.ts has sendWhatsApp function using fetch to graph.facebook.com/v23.0
- dispatch-notifications has 'whatsapp' case in channel dispatch loop
- WhatsApp case checks profiles.settings.whatsapp_opt_in before dispatch
- Each delivery logged to alert_deliveries with channel_type='whatsapp'
- Uses Deno.env.get for WHATSAPP_ACCESS_TOKEN and WHATSAPP_PHONE_NUMBER_ID
- Per-recipient try/catch so one failure does not block other recipients
- Existing email and telegram cases are NOT modified
  </verify>
  <done>
notification-formatters.ts exports formatAlertWhatsAppParams for template parameter building with critical_alert and balance_warning template selection. dispatch-notifications/index.ts has sendWhatsApp function (fetch to Graph API v23.0) and a 'whatsapp' channel case that checks per-user opt-in, sends template messages, and logs deliveries to alert_deliveries. Existing email and telegram dispatch paths are unchanged.
  </done>
</task>

</tasks>

<verification>
- SQL migration is idempotent and does not create new tables
- WhatsApp dispatch uses same fire-and-forget pattern as email/telegram for delivery logging
- Template parameter ordering matches the approved template definitions from the research
- Per-user opt-in is checked at dispatch time, not just at configuration time
- No hardcoded secrets -- WHATSAPP_ACCESS_TOKEN and WHATSAPP_PHONE_NUMBER_ID from Deno.env
- Graph API v23.0 matches the Facebook API version used in Phase 2
- Emergency alerts still bypass quiet hours (existing logic, no change needed)
</verification>

<success_criteria>
- Database migration adds CHECK constraint to notification_channels.channel_type
- dispatch-notifications handles 'whatsapp' channel type alongside existing email/telegram
- WhatsApp messages use approved template names with parameterized body components
- Per-user opt-in verified before every WhatsApp dispatch
- All deliveries logged to alert_deliveries with appropriate status
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md`
</output>
