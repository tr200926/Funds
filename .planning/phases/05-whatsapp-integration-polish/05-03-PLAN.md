---
phase: 05-whatsapp-integration-polish
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Meta WhatsApp Business prerequisites (verification, phone number, templates, secrets) are satisfied"
    - "Opted-in users receive WhatsApp template alerts triggered by real data"
    - "Users who opt out no longer receive WhatsApp messages"
    - "Dashboard allows configuring WhatsApp channels and opt-in preferences end to end"
    - "alert_deliveries records WhatsApp sends with accurate status + payload"
  artifacts:
    - path: "supabase/migrations/20260213000001_whatsapp_channel_support.sql"
      provides: "Constraint + defaults enabling WhatsApp channel data"
      contains: "notification_channels_channel_type_check"
    - path: "supabase/functions/dispatch-notifications/index.ts"
      provides: "WhatsApp dispatch implementation"
      contains: "sendWhatsApp"
    - path: "dashboard/src/components/notifications/channel-form.tsx"
      provides: "WhatsApp channel configuration UI"
      contains: "channel_type === 'whatsapp'"
    - path: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      provides: "Per-user opt-in control"
      contains: "WhatsAppOptIn"
  key_links:
    - from: "dashboard/src/components/notifications/channel-form.tsx"
      to: "supabase/functions/dispatch-notifications/index.ts"
      via: "notification_channels records consumed by dispatch"
      pattern: "channel_type: 'whatsapp'"
    - from: "profiles.settings.whatsapp_opt_in"
      to: "dispatch-notifications"
      via: "opt-in guard before send"
      pattern: "settings->>\'whatsapp_opt_in'"
    - from: "alert_deliveries"
      to: "WhatsApp Cloud API"
      via: "response_data storing Meta response"
      pattern: "channel_type = 'whatsapp'"
---

<objective>
Validate the WhatsApp channel end to end: external prerequisites, dashboard UX, opt-in enforcement, dispatch function, and delivery logging.

Purpose: Before closing Phase 5 we need human confirmation that Meta prerequisites are satisfied and real template messages reach only opted-in users. This plan documents those checks.
Output: Verification notes (or issues) proving WhatsApp alerts work for opted-in users and stay silent for opted-out users.
</objective>

<execution_context>
@C:/Users/hossa/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md
@.planning/phases/05-whatsapp-integration-polish/05-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Confirm Meta WhatsApp prerequisites</name>
  <files>N/A</files>
  <action>
These checks require access to Meta Business Suite and Supabase secrets; they cannot be automated from the repo. Perform all four steps before triggering alerts.
  </action>
  <how-to-verify>
1. **Business verification** – Visit Meta Business Suite → Settings → Business Info. Ensure status is "Verified". If not, initiate verification (can take 1–4 weeks) and pause execution.
2. **Phone number registration** – In WhatsApp Manager → Phone Numbers, confirm a dedicated WhatsApp Business number shows "Connected". If using Meta test number, list allowed recipient phones.
3. **Template approval** – In WhatsApp Manager → Message Templates, ensure `balance_warning`, `critical_alert`, and `daily_summary` exist, English language, category=UTILITY, status=Approved. Re-submit if rejected.
4. **Edge Function secrets** – Run `npx supabase secrets list --project-ref <project-ref>` from the repo root. Verify `WHATSAPP_ACCESS_TOKEN` and `WHATSAPP_PHONE_NUMBER_ID` are present. If missing, set them via `npx supabase secrets set ...` using the permanent System User token.
  </how-to-verify>
  <verify>Each prerequisite documented above has been completed and evidence captured (screenshots or command output).</verify>
  <done>Meta business verification, WhatsApp number registration, template approvals, and Edge Function secrets are all confirmed.</done>
  <resume-signal>Type "prerequisites confirmed" (or describe blockers) to continue.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end WhatsApp alert verification</name>
  <files>N/A</files>
  <action>
Run the six-step manual verification to prove WhatsApp alerts work only for opted-in users and surface correctly in the dashboard + database.
  </action>
  <what-built>
Complete WhatsApp integration: schema changes, dispatch-notifications additions, dashboard channel form, and per-user opt-in toggle.
  </what-built>
  <how-to-verify>
1. **Database sanity**
   - Inpspect migration results: `\d+ notification_channels` to confirm channel_type CHECK constraint and `\d+ profiles` to confirm settings default.
   - Ensure `idx_profiles_whatsapp_opt_in` exists via `\di idx_profiles_whatsapp_opt_in`.
2. **Opt-in from UI**
   - Log into the dashboard, visit `/settings/profile`, toggle "Enable WhatsApp Alerts" on, enter a valid phone (+20…), and save. Expect a success toast.
   - Query Supabase: `select settings from profiles where id='<user-id>';` – expect whatsapp_opt_in true, phone string, timestamp populated.
3. **Create WhatsApp channel**
   - Go to `/settings/notifications`, click "Add Channel", choose WhatsApp, name it, configure severity threshold, add the opted-in user (phone prefilled), and save. Expect the channel in the list with WhatsApp badge.
4. **Trigger alert + receive message**
   - Insert a balance snapshot or spend record that violates a rule (example provided below). Wait for evaluate-alerts → dispatch-notifications to fire. Verify WhatsApp message arrives using the approved template, with substituted parameters.
   - Example SQL: `insert into balance_snapshots (ad_account_id, org_id, balance, snapshot_date, source) values ('<account-id>', '<org-id>', 75, now(), 'manual_whatsapp_test');`
   - Inspect `alert_deliveries` for latest rows filtered by channel_type='whatsapp'; expect status='sent', recipient=phone, response_data containing Meta message ID.
5. **Opt-out enforcement**
   - Return to `/settings/profile`, disable WhatsApp alerts (switch off) and save.
   - Trigger another alert (same insert). Expected: no WhatsApp message, no new alert_deliveries rows for whatsapp.
6. **Validation UX**
   - Attempt to create a WhatsApp channel with an invalid phone (missing '+') and with zero recipients; ensure the form surfaces inline validation errors and blocks submission.
  </how-to-verify>
  <verify>Document outcomes for steps 1-6 above (screenshots or logs) and ensure each expected behavior occurs.</verify>
  <done>End-to-end flow validated: opted-in user receives WhatsApp template, opted-out user is skipped, alert_deliveries entries accurate, form validation enforced.</done>
  <resume-signal>Respond "approved" when every step passes or describe the failing step(s).</resume-signal>
</task>

</tasks>

<verification>
- Meta prerequisites confirmed and secrets configured via `npx supabase secrets list`
- Opt-in/out actions reflected in profiles.settings and UI toasts
- WhatsApp alert delivered once, skipped after opt-out, and logged in alert_deliveries
- Channel form validation prevents invalid data
</verification>

<success_criteria>
- At least one WhatsApp template message successfully delivered to an opted-in test user
- Opted-out users receive no WhatsApp messages even when in the channel config
- Dashboard channel + profile flows function without errors
- alert_deliveries shows accurate whatsapp entries with API response metadata
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-03-SUMMARY.md`
</output>
