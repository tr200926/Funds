---
phase: 05-whatsapp-integration-polish
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "WhatsApp template messages are delivered to opted-in users when alerts fire"
    - "Non-opted-in users do NOT receive WhatsApp messages"
    - "WhatsApp channel can be configured from the dashboard notification settings"
    - "Per-user opt-in toggle works from the profile settings page"
    - "WhatsApp deliveries appear in alert history with correct status"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete WhatsApp integration end-to-end: template message delivery, per-user opt-in enforcement, dashboard channel configuration, and delivery tracking.

Purpose: This is the final checkpoint to confirm all Phase 5 work integrates correctly before marking the phase complete. It covers the human-only steps (Meta template approval verification, WhatsApp Business registration) and functional verification of the automated code.
Output: Verified WhatsApp alerting flow or documented issues to address.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md
@.planning/phases/05-whatsapp-integration-polish/05-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Verify Meta WhatsApp Business prerequisites</name>
  <action>
Before testing the integration, the following external prerequisites must be confirmed. These are human-only actions that cannot be automated.
  </action>
  <how-to-verify>
1. **Meta Business Verification:** Confirm Targetspro's Meta Business account is verified for WhatsApp Business Platform access.
   - Location: Meta Business Suite -> Settings -> Business Info -> Business Verification Status
   - Expected: "Verified" status. If "Not Verified", initiate verification (1-4 weeks).

2. **WhatsApp Phone Number Registration:**
   - Confirm a dedicated phone number is registered in WhatsApp Manager
   - Location: Meta Business Suite -> WhatsApp Manager -> Phone Numbers
   - Expected: One phone number listed with "Connected" status
   - If using Meta test phone number: confirm at least 1 test recipient phone is added under "To" numbers

3. **Template Approval Status:**
   - Location: Meta Business Suite -> WhatsApp Manager -> Message Templates
   - Verify these 3 templates exist and have "Approved" status:
     - `balance_warning` (UTILITY category)
     - `critical_alert` (UTILITY category)
     - `daily_summary` (UTILITY category)
   - If any template is "Pending", wait for approval (30 min - 48 hours)
   - If any template is "Rejected", note the reason and resubmit with corrected wording

4. **Edge Function Secrets:**
   - Confirm WhatsApp secrets are set:
     ```
     npx supabase secrets list
     ```
   - Verify WHATSAPP_ACCESS_TOKEN and WHATSAPP_PHONE_NUMBER_ID appear in the list
   - If missing, set them:
     ```
     npx supabase secrets set WHATSAPP_ACCESS_TOKEN=EAA...
     npx supabase secrets set WHATSAPP_PHONE_NUMBER_ID=...
     ```
  </how-to-verify>
  <resume-signal>Type "prerequisites confirmed" when all 4 items are verified, or describe which items are not ready.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end WhatsApp alert flow verification</name>
  <action>
Verify complete WhatsApp integration: database migration, dispatch-notifications WhatsApp case, per-user opt-in, and dashboard UI for channel configuration and opt-in management. Follow the 6-step verification procedure below.
  </action>
  <what-built>
Complete WhatsApp integration: database migration, dispatch-notifications WhatsApp case, per-user opt-in, and dashboard UI for channel configuration and opt-in management.
  </what-built>
  <how-to-verify>
**Step 1: Verify database migration applied**
```sql
-- Check notification_channels CHECK constraint
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conname = 'notification_channels_channel_type_check';
-- Expected: CHECK (channel_type IN ('email', 'telegram', 'whatsapp', 'webhook'))

-- Check profiles.settings default
SELECT column_default FROM information_schema.columns
WHERE table_name = 'profiles' AND column_name = 'settings';
-- Expected: '{}'::jsonb
```

**Step 2: Configure WhatsApp opt-in for a test user**
1. Navigate to `/settings/profile` in the dashboard
2. Find the "WhatsApp Alerts" section
3. Toggle "Enable WhatsApp Alerts" to ON
4. Enter a valid WhatsApp phone number (with country code, e.g., +201234567890)
5. Click Save
6. Expected: Success toast, "WhatsApp preferences saved"
7. Verify in Supabase: `SELECT settings FROM profiles WHERE id = '<user-id>'`
   - Expected: `{ "whatsapp_opt_in": true, "whatsapp_phone": "+201234567890", "whatsapp_opted_in_at": "2026-..." }`

**Step 3: Create a WhatsApp notification channel**
1. Navigate to `/settings/notifications` in the dashboard
2. Click "Add Channel"
3. Select channel type: "WhatsApp"
4. Enter a name: "WhatsApp Alerts Test"
5. Add a recipient: select the test user from Step 2, verify phone is pre-filled
6. Set min severity to "info" (so all alerts trigger)
7. Click Save
8. Expected: New channel card appears in the channel list with WhatsApp icon

**Step 4: Trigger an alert and verify WhatsApp delivery**
1. Create a test alert by inserting a spend_record or balance_snapshot that triggers a configured alert rule:
   ```sql
   -- Option A: Insert a balance snapshot below threshold to trigger balance_threshold rule
   INSERT INTO balance_snapshots (ad_account_id, org_id, balance, snapshot_date, source)
   VALUES ('<account-id>', '<org-id>', 100, CURRENT_DATE, 'manual_test');
   ```
2. Wait 5-10 seconds for the trigger -> evaluate-alerts -> dispatch-notifications chain
3. Check the test user's WhatsApp for a template message
4. Expected: WhatsApp message received with correct template (balance_warning or critical_alert) and filled parameters
5. Check alert_deliveries in Supabase:
   ```sql
   SELECT * FROM alert_deliveries WHERE channel_type = 'whatsapp' ORDER BY created_at DESC LIMIT 5;
   ```
   - Expected: Row with status='sent', recipient=phone number, response_data with WhatsApp message ID

**Step 5: Verify opt-in enforcement**
1. Navigate to `/settings/profile` and toggle WhatsApp OFF for the test user
2. Trigger another alert (repeat Step 4 insert)
3. Expected: NO WhatsApp message received
4. Check alert_deliveries: should NOT have a new 'whatsapp' delivery for this alert (user was skipped)

**Step 6: Verify channel form validation**
1. Try adding a WhatsApp channel with invalid phone number (e.g., "12345" without +)
2. Expected: Validation error shown
3. Try adding a WhatsApp channel with no recipients
4. Expected: Validation error "At least one recipient required"
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 steps pass, or describe specific failures.</resume-signal>
</task>

</tasks>

<verification>
- Meta Business prerequisites confirmed (verification, phone number, templates, secrets)
- WhatsApp template message delivered to opted-in user's phone
- Non-opted-in users are skipped (no delivery row created)
- Dashboard channel form creates valid WhatsApp channel with correct config shape
- Profile opt-in toggle persists to profiles.settings JSONB
- alert_deliveries table tracks WhatsApp dispatches with correct status
- Phone number validation works in both channel form and opt-in component
</verification>

<success_criteria>
- At least one WhatsApp template message successfully delivered to a test phone
- Opt-in enforcement verified (opted-out user receives no message)
- Dashboard UI for WhatsApp channel configuration functional
- No regressions to existing email and telegram delivery
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-03-SUMMARY.md`
</output>
