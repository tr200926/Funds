---
phase: 05-whatsapp-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dashboard/src/components/notifications/channel-form.tsx
  - dashboard/src/lib/validators/notification-channels.ts
  - dashboard/src/components/notifications/whatsapp-opt-in.tsx
  - dashboard/src/app/(dashboard)/settings/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/manager can add a WhatsApp notification channel with recipient phone numbers and user IDs"
    - "Channel form dynamically shows WhatsApp-specific config fields when 'whatsapp' channel type is selected"
    - "Individual users can toggle WhatsApp opt-in and provide their phone number from the profile settings page"
    - "Opt-in state is stored in profiles.settings JSONB with whatsapp_opt_in boolean, whatsapp_phone string, and whatsapp_opted_in_at timestamp"
    - "Channel form validation accepts WhatsApp as a valid channel_type"
  artifacts:
    - path: "dashboard/src/components/notifications/channel-form.tsx"
      provides: "Extended channel form with WhatsApp config fields (recipient phone + user_id pairs)"
      contains: "whatsapp"
    - path: "dashboard/src/lib/validators/notification-channels.ts"
      provides: "Zod schema updated with whatsapp channel_type and WhatsApp-specific config validation"
      contains: "whatsapp"
    - path: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      provides: "Per-user WhatsApp opt-in toggle component with phone number input"
      contains: "WhatsAppOptIn"
    - path: "dashboard/src/app/(dashboard)/settings/profile/page.tsx"
      provides: "Profile settings page with WhatsApp opt-in section"
      contains: "WhatsAppOptIn"
  key_links:
    - from: "dashboard/src/components/notifications/channel-form.tsx"
      to: "dashboard/src/lib/validators/notification-channels.ts"
      via: "Zod schema import for form validation"
      pattern: "import.*channelFormSchema"
    - from: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      to: "supabase profiles table"
      via: "Supabase update to profiles.settings JSONB"
      pattern: "from\\('profiles'\\).*update"
    - from: "dashboard/src/app/(dashboard)/settings/profile/page.tsx"
      to: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      via: "import and render WhatsAppOptIn component"
      pattern: "import.*WhatsAppOptIn"
---

<objective>
Add WhatsApp as a channel option in the dashboard notification settings and build a per-user opt-in toggle for WhatsApp alerts on the profile settings page.

Purpose: The backend (Plan 01) can dispatch WhatsApp messages, but users need UI to configure WhatsApp channels (admin/manager) and individually opt in/out of receiving WhatsApp alerts (all users). R6.3 requires explicit per-user opt-in before WhatsApp messages can be sent.
Output: Extended channel-form with WhatsApp support, updated Zod validation, new WhatsApp opt-in component, extended profile settings page.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md
@dashboard/src/components/notifications/channel-form.tsx
@dashboard/src/components/notifications/channel-list.tsx
@dashboard/src/lib/validators/notification-channels.ts
@dashboard/src/app/(dashboard)/settings/notifications/page.tsx
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend channel form and validation for WhatsApp</name>
  <files>
dashboard/src/components/notifications/channel-form.tsx
dashboard/src/lib/validators/notification-channels.ts
  </files>
  <action>
**Part A: Update Zod validation schema (notification-channels.ts)**

Extend the existing channel form Zod schema (created in Phase 4 Plan 04-03 or 04-04) to include 'whatsapp' as a valid channel_type.

Current schema has `channel_type: z.enum(['email', 'telegram'])`. Change to:
```typescript
channel_type: z.enum(['email', 'telegram', 'whatsapp']),
```

Add WhatsApp-specific config validation using z.discriminatedUnion or z.superRefine:
```typescript
// When channel_type is 'whatsapp', config must have a recipients array of { phone, user_id } objects
const whatsappConfigSchema = z.object({
  recipients: z.array(z.object({
    phone: z.string().regex(/^\+\d{10,15}$/, 'Phone must be E.164 format (e.g., +201234567890)'),
    user_id: z.string().uuid('Must be a valid user ID'),
  })).min(1, 'At least one recipient required'),
})
```

Use z.superRefine on the parent schema to conditionally validate config based on channel_type:
- If channel_type === 'email': config.recipients must be string array of valid emails (existing)
- If channel_type === 'telegram': config.chat_id must be a string (existing)
- If channel_type === 'whatsapp': config.recipients must be array of { phone, user_id } objects (new)

**Part B: Extend channel-form.tsx**

The existing channel-form.tsx (from Phase 4 Plan 04-04) has dynamic config fields for email (recipients textarea) and telegram (chat_id input). Add a third case for WhatsApp.

When channel_type === 'whatsapp', render:
1. **Recipients section** with a dynamic list of phone/user pairs:
   - For each recipient row:
     - Select dropdown to pick a user from the organization (fetch users from profiles where org_id matches)
     - Phone number input pre-filled from the selected user's profiles.settings.whatsapp_phone (if available), editable, with placeholder "+201234567890"
   - "Add Recipient" button to add another row
   - "Remove" button on each row
   - Help text: "Each recipient must have opted in to WhatsApp alerts in their profile settings. Only opted-in users will receive messages."

2. Update the Select component for channel_type to include a third option:
   ```tsx
   <SelectItem value="whatsapp">
     WhatsApp
   </SelectItem>
   ```
   Add a WhatsApp icon (use a message-circle icon from lucide-react as a stand-in, or a phone icon).

3. When switching channel_type in the Select, clear the config fields and reset to the appropriate empty state for the new type.

**Fetch org users** for the WhatsApp recipient selector:
- Query profiles where org_id = current org, select id, display_name (or email), settings
- Present as dropdown options. Show phone number if whatsapp_phone is in their settings.
- If user has whatsapp_opt_in=false in settings, show a warning badge "Not opted in" next to their name.

**Form submission for WhatsApp:** Transform the form state into the config format expected by the backend:
```typescript
config: {
  recipients: selectedUsers.map(u => ({
    phone: u.phone,    // E.164 format
    user_id: u.userId, // UUID
  }))
}
```

**Important:** Do NOT remove or modify the existing email and telegram config field rendering. Only ADD the whatsapp case alongside them.
  </action>
  <verify>
- notification-channels.ts Zod schema includes 'whatsapp' in channel_type enum
- WhatsApp config validation requires recipients array with phone (E.164) and user_id (UUID)
- channel-form.tsx renders WhatsApp-specific fields when channel_type='whatsapp' is selected
- User selector fetches org members from profiles table
- Shows "Not opted in" warning for users without whatsapp_opt_in
- Form submission produces correct config.recipients structure for WhatsApp
- Existing email and telegram fields remain unchanged
  </verify>
  <done>
Channel form supports WhatsApp as a third channel type with recipient user/phone selection, E.164 phone validation, and opt-in status indicators. Zod validation ensures WhatsApp config has properly formatted recipients array. Existing email and telegram config fields are unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create per-user WhatsApp opt-in component and profile page</name>
  <files>
dashboard/src/components/notifications/whatsapp-opt-in.tsx
dashboard/src/app/(dashboard)/settings/profile/page.tsx
  </files>
  <action>
**Part A: Create whatsapp-opt-in.tsx**

Create a new client component for per-user WhatsApp opt-in management.

```typescript
'use client'

interface WhatsAppOptInProps {
  userId: string
  initialOptIn: boolean
  initialPhone: string
}
```

Component behavior:
1. **State:** `optIn` (boolean), `phone` (string), `saving` (boolean)
2. **Layout:**
   - Card (shadcn/ui Card component) with title "WhatsApp Alerts"
   - Description text: "Receive alert notifications via WhatsApp. Your phone number must have WhatsApp installed."
   - Switch toggle labeled "Enable WhatsApp Alerts" with `optIn` state
   - When optIn is true, show:
     - Phone number Input (type="tel") with placeholder "+201234567890"
     - Help text: "Include country code (e.g., +20 for Egypt). This number must have WhatsApp installed."
     - Basic client-side validation: phone must start with '+' and be 10-16 digits
   - Save button (disabled while saving or when no changes)
   - Toast notification on save success/failure using sonner (or shadcn toast, match existing pattern)

3. **Save handler:**
   - Read current profiles.settings via Supabase query
   - Merge WhatsApp fields into existing settings (do NOT overwrite other settings keys):
     ```typescript
     const updatedSettings = {
       ...currentSettings,
       whatsapp_opt_in: optIn,
       whatsapp_phone: optIn ? phone : null,
       whatsapp_opted_in_at: optIn ? new Date().toISOString() : null,
     }
     ```
   - Update profiles.settings via Supabase: `.from('profiles').update({ settings: updatedSettings }).eq('id', userId)`
   - Show success toast: "WhatsApp preferences saved"
   - Show error toast on failure with error message

4. **Important UX details:**
   - When toggling opt-in OFF, clear the phone field and show brief explanation: "You will no longer receive WhatsApp alerts."
   - When toggling opt-in ON with no phone, focus the phone input automatically
   - Disable Save button if opt-in is true but phone is empty or invalid

**Part B: Extend or create profile settings page**

Check if `dashboard/src/app/(dashboard)/settings/profile/page.tsx` exists from Phase 3 or Phase 4.

**If it exists:** Add the WhatsAppOptIn component to the existing page, in a new section below existing profile settings. Import and render:
```tsx
<WhatsAppOptIn
  userId={user.id}
  initialOptIn={profile.settings?.whatsapp_opt_in ?? false}
  initialPhone={profile.settings?.whatsapp_phone ?? ''}
/>
```

**If it does NOT exist:** Create a new profile settings page at this path:
```tsx
// Server component
export default async function ProfileSettingsPage() {
  // 1. Get authenticated user session (using createServerClient from Supabase SSR)
  // 2. Fetch profile: supabase.from('profiles').select('*').eq('id', user.id).single()
  // 3. Render page title "Profile Settings"
  // 4. Render user info section (display name, email -- read-only for now)
  // 5. Render WhatsAppOptIn component with props from profile data
}
```

Add this page to the settings navigation. If a settings layout exists (from Phase 3/4 at `dashboard/src/app/(dashboard)/settings/layout.tsx`), add a "Profile" nav link pointing to `/settings/profile`. If no settings layout exists, include a breadcrumb or back link to the main settings page.

**Sidebar navigation:** If the Phase 3 sidebar exists, ensure Settings section has a "Profile" sub-item. If not, add a TODO comment noting sidebar integration.

**Important:** Use createClient from `@/lib/supabase/client` for client-side operations in the opt-in component. Use createServerClient for server-side data fetching in the page component. Follow the existing Supabase SSR patterns established in Phase 3.
  </action>
  <verify>
- whatsapp-opt-in.tsx exports WhatsAppOptIn component with userId, initialOptIn, initialPhone props
- Component renders Switch toggle, phone Input (conditional), and Save button
- Save handler merges whatsapp_opt_in, whatsapp_phone, whatsapp_opted_in_at into profiles.settings
- Does NOT overwrite other settings keys (uses spread operator on existing settings)
- Phone validation requires E.164-like format (starts with +, 10-16 digits)
- Profile settings page renders WhatsAppOptIn with data from authenticated user's profile
- Uses Supabase SSR patterns consistent with Phase 3
- Toast notifications on save success/failure
  </verify>
  <done>
WhatsAppOptIn component provides per-user toggle for WhatsApp alerts with phone number input, E.164 validation, and JSONB-merge save to profiles.settings. Profile settings page at /settings/profile renders the opt-in component with server-fetched initial state. Opt-in timestamps are recorded for compliance audit trail.
  </done>
</task>

</tasks>

<verification>
- Channel form shows WhatsApp as a third channel type option
- WhatsApp config fields show user selector with opt-in status indicators
- Profile settings page has WhatsApp opt-in toggle that persists to profiles.settings
- Saving opt-in merges into JSONB without overwriting other settings
- E.164 phone format validated on both channel form and opt-in component
- All UI components use shadcn/ui and match existing dashboard design patterns
</verification>

<success_criteria>
- Admin can select 'whatsapp' when creating a notification channel and add user/phone recipients
- Individual users can enable/disable WhatsApp alerts from /settings/profile
- Phone numbers validated in E.164 format
- Opt-in state correctly stored in profiles.settings JSONB
- Existing email and telegram channel functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-02-SUMMARY.md`
</output>
