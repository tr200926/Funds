---
phase: 05-whatsapp-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dashboard/src/components/notifications/channel-form.tsx
  - dashboard/src/lib/validators/notification-channels.ts
  - dashboard/src/components/notifications/whatsapp-opt-in.tsx
  - dashboard/src/app/(dashboard)/settings/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Notification channel form exposes WhatsApp as a selectable type with dedicated config fields"
    - "WhatsApp channel config stores an array of {user_id, phone} recipients validated in E.164 format"
    - "Channel form surfaces opt-in status so admins only select opted-in users"
    - "Users can toggle WhatsApp alerts and save their phone number from /settings/profile"
    - "profiles.settings JSONB persists whatsapp_opt_in, whatsapp_phone, whatsapp_opted_in_at without clobbering other keys"
  artifacts:
    - path: "dashboard/src/lib/validators/notification-channels.ts"
      provides: "Updated Zod schema including whatsapp channel type + config refine"
      contains: "z.enum(['email', 'telegram', 'whatsapp'])"
    - path: "dashboard/src/components/notifications/channel-form.tsx"
      provides: "WhatsApp-specific UI with recipient rows and opt-in indicators"
      contains: "channel_type === 'whatsapp'"
    - path: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      provides: "Client component for opt-in toggle + phone input"
      contains: "WhatsAppOptIn"
    - path: "dashboard/src/app/(dashboard)/settings/profile/page.tsx"
      provides: "Profile settings page rendering WhatsAppOptIn with SSR-provided data"
      contains: "<WhatsAppOptIn"
  key_links:
    - from: "dashboard/src/components/notifications/channel-form.tsx"
      to: "dashboard/src/lib/validators/notification-channels.ts"
      via: "form schema import enforcing WhatsApp config"
      pattern: "channelFormSchema"
    - from: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      to: "profiles"
      via: "Supabase update merging whatsapp_* fields into settings"
      pattern: "from\\('profiles'\).*update"
    - from: "dashboard/src/app/(dashboard)/settings/profile/page.tsx"
      to: "dashboard/src/components/notifications/whatsapp-opt-in.tsx"
      via: "prop drilling of userId + initial settings"
      pattern: "import.*WhatsAppOptIn"
---

<objective>
Expose WhatsApp in the dashboard: admins configure channel recipients with validation, and individual users manage their WhatsApp opt-in + phone number from the profile settings page.

Purpose: Backend dispatch (Plan 01) is useless without UI to collect consent and configure recipients. This plan satisfies R6.2/R6.3 by wiring both the admin form and the per-user preference toggle.
Output: Updated channel validator + form, new WhatsAppOptIn component, extended /settings/profile page.
</objective>

<execution_context>
@C:/Users/hossa/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-whatsapp-integration-polish/05-RESEARCH.md
@.planning/phases/05-whatsapp-integration-polish/05-01-SUMMARY.md
@dashboard/src/components/notifications/channel-form.tsx
@dashboard/src/components/notifications/channel-list.tsx
@dashboard/src/lib/validators/notification-channels.ts
@dashboard/src/app/(dashboard)/settings/notifications/page.tsx
@dashboard/src/app/(dashboard)/settings/profile/page.tsx
@dashboard/src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend channel form + validation for WhatsApp</name>
  <files>
dashboard/src/lib/validators/notification-channels.ts
dashboard/src/components/notifications/channel-form.tsx
  </files>
  <action>
Update the Zod schema and form component so admins/managers can add WhatsApp channels while respecting opt-in data.

**Schema**
- Change `channel_type` enum to include `'whatsapp'`.
- Introduce `const whatsappRecipientsSchema = z.array(z.object({ user_id: z.string().uuid(), phone: z.string().regex(/^\+\d{10,15}$/, 'Use international E.164 format (e.g., +201234567890)') })).min(1, 'At least one recipient required')`.
- Use `z.discriminatedUnion('channel_type', [...])` or `z.superRefine` to enforce config shape per channel:
  - email: recipients string array (existing behavior)
  - telegram: chat_id string (existing behavior)
  - whatsapp: recipients as defined above
- Export helper types if channel-form relies on them (e.g., `type WhatsAppRecipient = z.infer<typeof whatsappRecipientsSchema>[number]`).

**Form**
- In the `Select` for channel types, add a WhatsApp option with an icon (use lucide-react `MessageCircle` or similar already installed) and explanatory text.
- When `channel_type === 'whatsapp'`, render a dedicated section:
  - Load org users upfront (re-use existing Supabase data fetch used by email recipients). Query `profiles` for `id, display_name, email, settings` filtered by `org_id`.
  - Provide a Combobox/Select to choose a user per recipient row; show badge text `Not opted in` if their `settings.whatsapp_opt_in` is false.
  - Provide phone Input prefilled with the user's saved `whatsapp_phone` when available; allow manual editing.
  - Buttons to add/remove recipient rows; ensure removing the last row resets to empty state but still validates via schema.
  - Helper text reminding admins to only add opted-in users.
- Reset config when switching channel_type so previous config blobs don’t leak between channel types.
- Before submit, transform UI state into `{ channel_type: 'whatsapp', config: { recipients: [{ user_id, phone }] } }` for Supabase insert.

Keep the Next.js dashboard isolated in `dashboard/` per project decision and preserve existing email/telegram UX.
  </action>
  <verify>
- Validator accepts `'whatsapp'` enum value and enforces recipients array with UUID + E.164 phone
- channel-form renders WhatsApp-specific UI when selected and resets config when switching away
- Org users populate the recipient dropdown and show opt-in badges sourced from `settings`
- Form submission posts config.recipients matching schema structure
- Email/Telegram form paths remain identical to current behavior
  </verify>
  <done>
Channel form + validator treat WhatsApp as a first-class channel with validated recipients, opt-in indicators, and clean config serialization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build WhatsApp opt-in component and wire /settings/profile</name>
  <files>
dashboard/src/components/notifications/whatsapp-opt-in.tsx
dashboard/src/app/(dashboard)/settings/profile/page.tsx
  </files>
  <action>
Give every user a way to manage their WhatsApp consent + phone number directly inside the dashboard.

**Component** (`dashboard/src/components/notifications/whatsapp-opt-in.tsx`)
- Client component with props `{ userId: string; initialOptIn: boolean; initialPhone: string }`.
- Render shadcn `Card` (or Stack) containing:
  - Switch labeled “Enable WhatsApp Alerts” bound to local state
  - Conditional phone Input (type="tel") with placeholder `+201234567890`, validation error text when invalid, and helper copy.
  - Save button showing loading state and disabled when no changes or invalid input.
- Use `createClient` to fetch the current `profiles.settings` (to merge) and `update` the row. Merge JSON by spreading existing settings and overwriting `whatsapp_opt_in`, `whatsapp_phone`, `whatsapp_opted_in_at` (timestamp only when enabling). Do NOT drop other keys.
- Use toast/sonner pattern already used elsewhere to show success/failure messages. When toggling off, clear phone and set `whatsapp_opted_in_at` to `null`.
- Auto-focus the phone Input after switching opt-in on with an empty value.

**Profile page** (`/settings/profile`)
- If the page already exists, fetch the authenticated user and their profile using the established Supabase SSR helpers (`createServerClient`, `getUser`). If not, create the page using Phase 3 layout conventions.
- Render general profile info as currently done, then add a new “WhatsApp Alerts” section injecting `<WhatsAppOptIn userId={user.id} initialOptIn={profile.settings?.whatsapp_opt_in ?? false} initialPhone={profile.settings?.whatsapp_phone ?? ''} />`.
- Ensure the route is protected by the same `(dashboard)` middleware (already provided) and add a navigation link if the settings sidebar expects all child pages to be enumerated.

This work must stay within `dashboard/` per repo decision and reuse Supabase SSR patterns introduced in Phase 3.
  </action>
  <verify>
- whatsapp-opt-in.tsx exports the component, uses Switch/Input/Button, and merges JSONB settings without losing other keys
- Save button disabled for invalid numbers and shows toast feedback
- Profile page renders the component with server-fetched props and uses the existing auth helpers
- Opting in/out updates `profiles.settings` with `whatsapp_opt_in`, `whatsapp_phone`, and timestamp fields visible via Supabase
  </verify>
  <done>
Users can turn WhatsApp alerts on/off, store their phone number, and those values persist in profiles.settings for dispatch enforcement.
  </done>
</task>

</tasks>

<verification>
- Visiting `/settings/notifications` shows WhatsApp choice with validated recipient UI
- Validation rejects malformed phone numbers or empty recipient arrays
- `/settings/profile` exposes the WhatsApp opt-in card, saves preferences, and shows success toast
- Database records reflect whatsapp_opt_in true/false and phone strings per user without overwriting other JSONB fields
</verification>

<success_criteria>
- Admins can add WhatsApp channels referencing user opt-in status and phone numbers
- WhatsApp config serialized as `{ recipients: [{ user_id, phone }] }` and validated on submit
- Individual users control whatsapp_opt_in + phone from their profile
- Stored JSONB settings include opt-in state, phone, and timestamp for audit history
</success_criteria>

<output>
After completion, create `.planning/phases/05-whatsapp-integration-polish/05-02-SUMMARY.md`
</output>
