---
phase: 04-alert-engine-email-telegram
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03", "04-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All alert engine components are integrated and verifiable end-to-end"
    - "Database triggers, Edge Functions, and dashboard UI work together"
  artifacts: []
  key_links:
    - from: "supabase/migrations/20260212200001_alert_engine_triggers.sql"
      to: "supabase/functions/evaluate-alerts/index.ts"
      via: "pg_net trigger invocation"
      pattern: "evaluate-alerts"
    - from: "supabase/functions/evaluate-alerts/index.ts"
      to: "supabase/functions/dispatch-notifications/index.ts"
      via: "fire-and-forget fetch"
      pattern: "dispatch-notifications"
    - from: "supabase/functions/dispatch-notifications/index.ts"
      to: "Resend + Telegram APIs"
      via: "HTTPS POST"
      pattern: "api\\.resend\\.com|api\\.telegram\\.org"
    - from: "dashboard/src/app/(dashboard)/alerts/page.tsx"
      to: "supabase alerts table"
      via: "Realtime subscription + query"
      pattern: "from\\('alerts'\\)"
---

<objective>
Verify the complete alert engine integration: database triggers fire Edge Functions on data arrival, alerts are evaluated and dispatched via Email and Telegram, escalation promotes unacknowledged alerts, and the dashboard shows alert history with acknowledgment.

Purpose: This is the final checkpoint ensuring all components from Plans 01-04 work together as a complete system before considering Phase 4 done.
Output: Verification that the alert engine meets all R5.1-R5.9 success criteria.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-alert-engine-email-telegram/04-RESEARCH.md
@.planning/phases/04-alert-engine-email-telegram/04-01-SUMMARY.md
@.planning/phases/04-alert-engine-email-telegram/04-02-SUMMARY.md
@.planning/phases/04-alert-engine-email-telegram/04-03-SUMMARY.md
@.planning/phases/04-alert-engine-email-telegram/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Edge Function deployment readiness</name>
  <files></files>
  <action>
Run verification checks on all alert engine components:

1. **SQL migration syntax:** Read the migration file and verify it contains all required elements:
   - pg_net extension
   - is_alert_in_cooldown function
   - invoke_alert_evaluation function
   - invoke_status_change_evaluation function
   - 3 triggers (spend INSERT, balance INSERT, status UPDATE)
   - pg_cron schedule

2. **Edge Functions structure:** Verify all 3 Edge Functions exist with correct structure:
   ```bash
   ls supabase/functions/evaluate-alerts/index.ts
   ls supabase/functions/dispatch-notifications/index.ts
   ls supabase/functions/escalate-alerts/index.ts
   ls supabase/functions/_shared/types.ts
   ls supabase/functions/_shared/constants.ts
   ls supabase/functions/_shared/supabase-client.ts
   ls supabase/functions/_shared/alert-evaluators.ts
   ls supabase/functions/_shared/notification-formatters.ts
   ```

3. **Import chain verification:** Check that each Edge Function correctly imports from _shared:
   - evaluate-alerts imports: types.ts, supabase-client.ts, alert-evaluators.ts
   - dispatch-notifications imports: types.ts, supabase-client.ts, constants.ts, notification-formatters.ts
   - escalate-alerts imports: supabase-client.ts, constants.ts

4. **Dashboard TypeScript compilation:** Run type checking on dashboard:
   ```bash
   cd dashboard && npx tsc --noEmit 2>&1 | head -50
   ```

5. **Verify no hardcoded secrets:** Search all files for potential secret leaks:
   ```bash
   grep -rn "re_" supabase/functions/ --include="*.ts" | grep -v "import\|require\|comment"
   grep -rn "sk_\|pk_\|secret" supabase/functions/ --include="*.ts" | grep -v "Deno.env\|vault\|comment\|interface\|type"
   ```

6. **Generate verification report** documenting:
   - All files created/modified
   - Components per requirement (R5.1-R5.9 mapping)
   - Any gaps or missing connections
  </action>
  <verify>
- All 8 Edge Function files exist (3 entry points + 5 shared modules)
- SQL migration contains all required triggers and functions
- No hardcoded secrets found in any TypeScript or SQL files
- Dashboard TypeScript compiles without errors
- Each requirement R5.1-R5.9 has at least one implementing component
  </verify>
  <done>
All alert engine files exist, imports resolve correctly, no secrets are hardcoded, TypeScript compiles, and every requirement R5.1-R5.9 maps to implemented components.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual verification checkpoint</name>
  <what-built>
Complete alert engine with:
- Database triggers (pg_net) on spend_records INSERT, balance_snapshots INSERT, ad_accounts status UPDATE
- 3 Edge Functions: evaluate-alerts (rule evaluation + cooldown), dispatch-notifications (email via Resend + Telegram), escalate-alerts (severity promotion)
- Dashboard alert rules management page at /alerts/rules (CRUD + toggle)
- Dashboard alert history page at /alerts (filterable DataTable + real-time + acknowledge)
- Dashboard notification channels page at /settings/notifications (email/telegram config)
- Zod-validated forms, role-based access, severity badges, quiet hours support
  </what-built>
  <how-to-verify>
**Prerequisites (before testing):**
1. Supabase project must be running with the Phase 1 schema applied
2. Run the new migration: `npx supabase db push` or apply via SQL Editor
3. Create Vault secrets: `SELECT vault.create_secret('<url>', 'supabase_url'); SELECT vault.create_secret('<key>', 'service_role_key');`
4. Set Edge Function secrets: `npx supabase secrets set RESEND_API_KEY=re_xxx TELEGRAM_BOT_TOKEN=xxx`
5. Deploy Edge Functions: `npx supabase functions deploy evaluate-alerts && npx supabase functions deploy dispatch-notifications && npx supabase functions deploy escalate-alerts`
6. Start dashboard: `cd dashboard && npm run dev`

**Verification Steps:**

**Step 1 -- Alert Rules UI:**
1. Visit http://localhost:3000/alerts/rules
2. Click "Create Rule" and create a balance_threshold rule: name="Low Balance Test", severity=warning, threshold=10000, cooldown=5 min, target=All Accounts
3. Verify the rule appears in the list
4. Toggle the rule inactive, then active again
5. Edit the rule to change the threshold to 5000

**Step 2 -- Notification Channels:**
1. Visit http://localhost:3000/settings/notifications
2. Verify the seeded "Default Email Alerts" channel appears
3. Add a Telegram channel: name="Test Telegram", chat_id=(your test chat id), min_severity=warning
4. Verify both channels appear

**Step 3 -- Alert Triggering (manual test):**
1. Insert a test balance_snapshot that puts an account below the threshold:
   ```sql
   INSERT INTO balance_snapshots (org_id, ad_account_id, balance, currency)
   VALUES ('00000000-0000-0000-0000-000000000001', '<test_account_id>', '4000', 'EGP');
   ```
2. Check Supabase Edge Function logs for evaluate-alerts invocation
3. Verify an alert row was created in the alerts table
4. Check if email was received (if Resend configured) and Telegram message sent (if bot configured)

**Step 4 -- Alert History + Acknowledgment:**
1. Visit http://localhost:3000/alerts
2. Verify the test alert appears in the list
3. Click the alert to open details
4. Click "Acknowledge" and verify status changes
5. Verify real-time: insert another test balance_snapshot and watch the new alert appear without page refresh

**Step 5 -- Cooldown Verification:**
1. Insert another balance_snapshot below threshold within 5 minutes
2. Verify no duplicate alert is created (cooldown active)

**Expected outcomes:**
- Alert rules CRUD works with validation
- Notification channels show with toggle functionality
- Alerts fire within 60 seconds of triggering data insert
- Email and Telegram notifications delivered (if credentials configured)
- Cooldown prevents duplicate alerts
- Acknowledge stops escalation
- Real-time updates work on alerts page
  </how-to-verify>
  <resume-signal>Type "approved" to confirm the alert engine works, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- R5.1: Alert rules configurable per account (balance threshold, time-to-depletion, spend spike, zero spend, status change)
- R5.2: Multi-channel delivery via Email (Resend) + Telegram Bot API
- R5.3: Escalation tiers (info -> warning -> critical -> emergency) with timeout-based promotion
- R5.4: Cooldown/deduplication via is_alert_in_cooldown RPC function
- R5.5: Alert configuration UI at /alerts/rules with admin/manager access
- R5.6: Alert history page at /alerts with acknowledgment via detail dialog
- R5.7: Time-to-depletion uses rolling average spend calculation
- R5.8: Emergency alerts bypass quiet hours in dispatch-notifications
- R5.9: Alerts fire 24/7 (no 9AM-12PM restriction -- triggers fire on every INSERT)
</verification>

<success_criteria>
- All 8 Edge Function files and 1 SQL migration exist and are syntactically valid
- Dashboard compiles and serves the 3 new pages (alerts, alerts/rules, settings/notifications)
- User confirms alert triggering, delivery, and acknowledgment work
- No hardcoded secrets in any file
</success_criteria>

<output>
After completion, create `.planning/phases/04-alert-engine-email-telegram/04-05-SUMMARY.md`
</output>
