---
phase: 04-alert-engine-email-telegram
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/lib/validators/alert-rules.ts
  - dashboard/src/components/alerts/severity-badge.tsx
  - dashboard/src/components/alerts/alert-rule-form.tsx
  - dashboard/src/components/alerts/alert-rule-list.tsx
  - dashboard/src/app/(dashboard)/alerts/rules/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/manager can view a list of all alert rules with name, type, severity, status, and cooldown"
    - "Admin/manager can create a new alert rule with type-specific configuration validated by Zod"
    - "Admin/manager can edit an existing alert rule"
    - "Admin/manager can toggle alert rules active/inactive"
    - "Viewer role can see alert rules but cannot create, edit, or toggle them"
  artifacts:
    - path: "dashboard/src/lib/validators/alert-rules.ts"
      provides: "Zod validation schemas for each alert rule type configuration"
      contains: "balanceThresholdConfig"
    - path: "dashboard/src/components/alerts/severity-badge.tsx"
      provides: "Reusable colored severity indicator component"
      contains: "SeverityBadge"
    - path: "dashboard/src/components/alerts/alert-rule-form.tsx"
      provides: "Form component for creating and editing alert rules with dynamic config fields per rule_type"
      contains: "AlertRuleForm"
    - path: "dashboard/src/components/alerts/alert-rule-list.tsx"
      provides: "DataTable listing alert rules with toggle switch and edit action"
      contains: "AlertRuleList"
    - path: "dashboard/src/app/(dashboard)/alerts/rules/page.tsx"
      provides: "Alert rules management page"
      contains: "export default"
  key_links:
    - from: "dashboard/src/components/alerts/alert-rule-form.tsx"
      to: "dashboard/src/lib/validators/alert-rules.ts"
      via: "Zod schema validation on form submit"
      pattern: "import.*from.*validators/alert-rules"
    - from: "dashboard/src/components/alerts/alert-rule-list.tsx"
      to: "supabase alert_rules table"
      via: "Supabase query for CRUD operations"
      pattern: "from\\('alert_rules'\\)"
    - from: "dashboard/src/app/(dashboard)/alerts/rules/page.tsx"
      to: "dashboard/src/components/alerts/alert-rule-list.tsx"
      via: "renders AlertRuleList component"
      pattern: "AlertRuleList"
---

<objective>
Build the dashboard UI for alert rule management: a page listing all rules with create/edit/toggle capabilities, powered by Zod-validated forms with dynamic configuration fields per rule type.

Purpose: This fulfills R5.5 (alert configuration UI) by giving admin/manager users the ability to configure what conditions trigger alerts, at what severity, with what cooldown. Without this, rules can only be created via direct database access.
Output: Zod validators, form component, list component, severity badge, and the /alerts/rules page.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-alert-engine-email-telegram/04-RESEARCH.md
@.planning/phases/03-dashboard-mvp-nextjs/03-01-PLAN.md
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod validators and severity badge component</name>
  <files>
dashboard/src/lib/validators/alert-rules.ts
dashboard/src/components/alerts/severity-badge.tsx
  </files>
  <action>
**alert-rules.ts (Zod validators):**

Install zod if not already in dashboard/package.json: `cd dashboard && npm install zod`

Create Zod schemas for alert rule configuration validation. Each rule_type has a different config shape:

```typescript
import { z } from 'zod'

// Config schemas per rule type
export const balanceThresholdConfig = z.object({
  threshold_value: z.coerce.number().positive('Threshold must be positive'),
  currency: z.string().default('EGP'),
})

export const spendSpikeConfig = z.object({
  percentage_increase: z.coerce.number().min(10, 'Min 10%').max(500, 'Max 500%'),
  lookback_days: z.coerce.number().min(2).max(30).default(7),
})

export const timeToDepletionConfig = z.object({
  days_remaining: z.coerce.number().min(1).max(30).default(3),
  lookback_days: z.coerce.number().min(3).max(30).default(7),
})

export const zeroSpendConfig = z.object({
  consecutive_days: z.coerce.number().min(1).max(14).default(2),
})

export const accountStatusChangeConfig = z.object({})
// No config needed -- triggers on any status change
```

Export a `getConfigSchema(ruleType: string)` helper that returns the appropriate Zod schema for a given rule_type string.

Export the base alert rule form schema:
```typescript
export const alertRuleFormSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters').max(100),
  description: z.string().max(500).optional().or(z.literal('')),
  rule_type: z.enum(['balance_threshold', 'spend_spike', 'time_to_depletion', 'zero_spend', 'account_status_change']),
  severity: z.enum(['info', 'warning', 'critical', 'emergency']),
  cooldown_minutes: z.coerce.number().min(5).max(1440).default(180),
  ad_account_id: z.string().uuid().nullable().optional(),
  is_active: z.boolean().default(true),
  config: z.record(z.unknown()), // validated separately per rule_type
})
```

Export type `AlertRuleFormValues = z.infer<typeof alertRuleFormSchema>` for use in form components.

Use `z.coerce.number()` (not `z.number()`) since form inputs produce strings.

**severity-badge.tsx:**

Create a small reusable component that renders a colored badge for alert severity levels. Use shadcn/ui Badge component (or a simple span with Tailwind classes if Badge is not yet installed).

```typescript
// Props: { severity: 'info' | 'warning' | 'critical' | 'emergency' }
// Colors: info=blue-100/blue-800, warning=yellow-100/yellow-800, critical=red-100/red-800, emergency=red-200/red-900 with font-bold
// Render: <span className="...">severity.toUpperCase()</span>
```

Export as named export `SeverityBadge`. Use Tailwind classes directly for colors, no CSS variables needed.
  </action>
  <verify>
- dashboard/src/lib/validators/alert-rules.ts exists with all 5 config schemas
- getConfigSchema returns correct schema for each rule_type string
- alertRuleFormSchema validates name (3-100 chars), rule_type (enum), severity (enum), cooldown_minutes (5-1440)
- Uses z.coerce.number() for numeric fields
- dashboard/src/components/alerts/severity-badge.tsx exists and exports SeverityBadge
- `cd dashboard && npx tsc --noEmit` passes (or at least the new files have no syntax errors)
  </verify>
  <done>
Zod validation schemas exist for all 5 alert rule types with proper coercion and defaults. SeverityBadge component renders colored badges for info/warning/critical/emergency levels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create alert rule form, list, and management page</name>
  <files>
dashboard/src/components/alerts/alert-rule-form.tsx
dashboard/src/components/alerts/alert-rule-list.tsx
dashboard/src/app/(dashboard)/alerts/rules/page.tsx
  </files>
  <action>
**alert-rule-form.tsx:**

Create a form component for creating and editing alert rules. Use shadcn/ui form components (Input, Select, Switch, Textarea, Button, Label) with React Hook Form + Zod resolver.

Props:
- `mode: 'create' | 'edit'`
- `initialValues?: Partial<AlertRuleFormValues>` (for edit mode)
- `adAccounts: { id: string, account_name: string }[]` (for account selector dropdown)
- `onSubmit: (values: AlertRuleFormValues & { config: Record<string, unknown> }) => Promise<void>`
- `onCancel: () => void`

Behavior:
1. Form fields: name (Input), description (Textarea, optional), rule_type (Select dropdown with 5 options), severity (Select with 4 severity options), cooldown_minutes (Input number, default 180), ad_account_id (Select with "All accounts" option + list of accounts), is_active (Switch toggle)
2. **Dynamic config section:** When rule_type changes, render different config fields:
   - balance_threshold: threshold_value (number input, label "Balance Threshold (EGP)")
   - spend_spike: percentage_increase (number input, label "Spike Percentage (%)"), lookback_days (number input, label "Lookback Days")
   - time_to_depletion: days_remaining (number input, label "Days Until Depletion Threshold"), lookback_days (number input)
   - zero_spend: consecutive_days (number input, label "Consecutive Zero-Spend Days")
   - account_status_change: no config fields, show helper text "Triggers on any account status change"
3. On submit: validate base form with alertRuleFormSchema, then validate config with getConfigSchema(rule_type). If both pass, call onSubmit. If validation fails, show field-level errors.
4. Render in a Dialog or Sheet (use shadcn Dialog). Show form title "Create Alert Rule" or "Edit Alert Rule" based on mode.

Install react-hook-form and @hookform/resolvers if not already in dashboard dependencies: `npm install react-hook-form @hookform/resolvers`

**alert-rule-list.tsx:**

Create a DataTable component listing all alert rules. Follow the existing DataTable pattern from Phase 3 (if it exists; otherwise create a table using shadcn/ui Table component).

Props:
- `orgId: string`

Behavior:
1. Fetch alert_rules from Supabase where org_id=orgId, ordered by created_at DESC
2. Use the server Supabase client (from dashboard/src/lib/supabase/server.ts)
3. Display columns: Name, Rule Type (formatted: "Balance Threshold", "Spend Spike", etc.), Severity (SeverityBadge), Target (account name or "All Accounts"), Cooldown (formatted: "3h", "30m"), Active (Switch toggle), Actions (Edit button)
4. Active toggle: On switch change, update alert_rules.is_active via Supabase. Show toast on success/failure.
5. Edit button: Opens AlertRuleForm in edit mode with the rule's current values
6. Create button: At top of table, "Create Rule" button that opens AlertRuleForm in create mode
7. On form submit (create): INSERT into alert_rules with org_id, created_by (current user id from useUser hook)
8. On form submit (edit): UPDATE alert_rules SET ... WHERE id=rule.id
9. After successful create/edit, refresh the list (use router.refresh() or revalidate)

**alerts/rules/page.tsx:**

Server component page at /alerts/rules route.

1. Get user session from server Supabase client
2. Get user's org_id from the session JWT claims (raw_app_meta_data.org_id) or from profiles table
3. Fetch ad_accounts list for the org (for the account selector in the form)
4. Render page title "Alert Rules" with description "Configure when and how alerts are triggered"
5. Render AlertRuleList component with orgId prop
6. Pass ad_accounts to the page for the form's account selector

**Role-based access:** Check user role from session. If role is 'viewer', hide create/edit/toggle controls. The list is still visible but read-only. Use the user role from the JWT claims or profile.

**Important:** If shadcn/ui components (Dialog, Select, Switch, Table, Input, Textarea, Label, Button) are not yet installed, install them: `cd dashboard && npx shadcn@latest add dialog select switch table input textarea label button` (some may already exist from Phase 3).
  </action>
  <verify>
- alert-rule-form.tsx exports AlertRuleForm component with mode, initialValues, adAccounts, onSubmit, onCancel props
- Form dynamically renders different config fields based on rule_type selection
- Validates with Zod schemas from validators/alert-rules.ts
- alert-rule-list.tsx exports AlertRuleList component that fetches and displays rules
- Has toggle switch for is_active with Supabase update
- Has create and edit functionality via AlertRuleForm
- alerts/rules/page.tsx is a valid Next.js page component
- Role check prevents viewers from creating/editing rules
- `cd dashboard && npx tsc --noEmit` compiles without errors (or new files have no syntax errors)
  </verify>
  <done>
Alert rules management page exists at /alerts/rules with: DataTable listing all rules (name, type, severity, target, cooldown, active status), create/edit forms with dynamic configuration fields validated by Zod per rule type, toggle switch for activating/deactivating rules, and role-based access control (viewer = read-only).
  </done>
</task>

</tasks>

<verification>
- Zod schemas validate all 5 rule type configs with proper coercion
- SeverityBadge renders 4 severity levels with distinct colors
- Alert rule form dynamically changes config fields when rule_type changes
- DataTable shows all alert rules with CRUD operations
- Role-based access restricts create/edit/toggle to admin/manager
- All components use the existing Supabase client pattern from Phase 3
</verification>

<success_criteria>
- /alerts/rules page renders a table of alert rules
- Admin can create a rule with balance_threshold type and see it in the list
- Admin can toggle a rule inactive and see the switch reflect the change
- Viewer sees the list but no create/edit/toggle controls
- Form validation shows errors for invalid inputs (e.g., negative threshold)
</success_criteria>

<output>
After completion, create `.planning/phases/04-alert-engine-email-telegram/04-03-SUMMARY.md`
</output>
