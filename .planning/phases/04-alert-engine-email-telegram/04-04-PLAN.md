---
phase: 04-alert-engine-email-telegram
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/components/alerts/alert-list.tsx
  - dashboard/src/components/alerts/alert-detail-dialog.tsx
  - dashboard/src/app/(dashboard)/alerts/page.tsx
  - dashboard/src/components/notifications/channel-form.tsx
  - dashboard/src/components/notifications/channel-list.tsx
  - dashboard/src/app/(dashboard)/settings/notifications/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/manager can view alert history with severity, account, status, and timestamp"
    - "Admin/manager can acknowledge a pending alert from the dashboard"
    - "Admin/manager can filter and sort alerts by severity, status, and date"
    - "Admin/manager can configure notification channels (email recipients, telegram chat_id)"
    - "Alert list updates in real-time when new alerts arrive via Supabase Realtime"
  artifacts:
    - path: "dashboard/src/components/alerts/alert-list.tsx"
      provides: "DataTable displaying alert history with filters"
      contains: "AlertList"
    - path: "dashboard/src/components/alerts/alert-detail-dialog.tsx"
      provides: "Dialog showing alert details with acknowledge/dismiss actions"
      contains: "AlertDetailDialog"
    - path: "dashboard/src/app/(dashboard)/alerts/page.tsx"
      provides: "Alert history page"
      contains: "export default"
    - path: "dashboard/src/components/notifications/channel-form.tsx"
      provides: "Form for adding/editing notification channels"
      contains: "ChannelForm"
    - path: "dashboard/src/components/notifications/channel-list.tsx"
      provides: "List of configured notification channels with enable/disable toggle"
      contains: "ChannelList"
    - path: "dashboard/src/app/(dashboard)/settings/notifications/page.tsx"
      provides: "Notification channel configuration page"
      contains: "export default"
  key_links:
    - from: "dashboard/src/components/alerts/alert-list.tsx"
      to: "supabase alerts table"
      via: "Supabase query with joined ad_accounts and alert_rules"
      pattern: "from\\('alerts'\\)"
    - from: "dashboard/src/components/alerts/alert-detail-dialog.tsx"
      to: "supabase alerts table"
      via: "UPDATE alerts SET status='acknowledged' on acknowledge action"
      pattern: "update.*alerts.*acknowledged"
    - from: "dashboard/src/components/alerts/alert-list.tsx"
      to: "Supabase Realtime"
      via: "useRealtime hook subscribing to alerts table changes"
      pattern: "useRealtime"
    - from: "dashboard/src/components/notifications/channel-list.tsx"
      to: "supabase notification_channels table"
      via: "Supabase CRUD operations"
      pattern: "from\\('notification_channels'\\)"
---

<objective>
Build the dashboard UI for alert history with acknowledgment capability and notification channel configuration, fulfilling R5.6 (alert history + acknowledgment) and the channel management portion of R5.2.

Purpose: Users need to see what alerts have fired, acknowledge them to stop escalation, and configure where notifications are delivered (which email addresses, which Telegram groups). Without this, alerts fire but users cannot interact with them in the dashboard.
Output: Alert history page with detail dialog, notification channels settings page.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-alert-engine-email-telegram/04-RESEARCH.md
@.planning/phases/03-dashboard-mvp-nextjs/03-01-PLAN.md
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create alert history page with detail dialog</name>
  <files>
dashboard/src/components/alerts/alert-list.tsx
dashboard/src/components/alerts/alert-detail-dialog.tsx
dashboard/src/app/(dashboard)/alerts/page.tsx
  </files>
  <action>
**alert-list.tsx:**

Create a DataTable component for alert history. This is the primary alert monitoring interface.

Props:
- `orgId: string`
- `userRole: 'admin' | 'manager' | 'viewer'`
- `userId: string` (for acknowledge_by)

Behavior:
1. Fetch alerts from Supabase: query alerts where org_id=orgId, select joined data: `*, ad_accounts(account_name, platform_id, currency), alert_rules(name, rule_type)`, ordered by created_at DESC, limit 100
2. **Real-time updates:** Use the useRealtime hook from Phase 3 (dashboard/src/hooks/use-realtime.ts) to subscribe to INSERT events on the alerts table. When a new alert arrives, prepend it to the list.
3. **Columns:**
   - Severity: SeverityBadge component (from 04-03)
   - Title: alert.title (clickable -- opens AlertDetailDialog)
   - Account: ad_accounts.account_name
   - Rule: alert_rules.name
   - Status: Badge showing pending/acknowledged/resolved/dismissed with appropriate colors
   - Time: formatted using formatCairoDate from dashboard/src/lib/format.ts (or Intl.DateTimeFormat with Africa/Cairo)
4. **Filters (above table):**
   - Severity filter: multi-select for info/warning/critical/emergency
   - Status filter: multi-select for pending/acknowledged/resolved/dismissed
   - Date range: optional date picker or "Last 24h / 7d / 30d" quick filters
   - Apply filters client-side on the fetched data (or via Supabase query params if performance needed)
5. **Sorting:** Click column headers to sort by severity, time, account name
6. **Empty state:** "No alerts yet" message when no alerts exist

**alert-detail-dialog.tsx:**

Dialog component showing full alert details and action buttons.

Props:
- `alert: AlertRow` (the full alert object with joined data)
- `open: boolean`
- `onOpenChange: (open: boolean) => void`
- `userRole: 'admin' | 'manager' | 'viewer'`
- `userId: string`
- `onAction: () => void` (callback to refresh list after action)

Content:
1. Header: SeverityBadge + alert.title
2. Body sections:
   - **Message:** alert.message (full text)
   - **Account:** account_name, platform, currency
   - **Rule:** rule name and type
   - **Context:** Render context_data as key-value pairs (balance, threshold, days_remaining, etc.)
   - **Delivery History:** Fetch alert_deliveries for this alert_id. Show each delivery: channel, recipient, status, sent_at, error_message if failed.
   - **Timeline:** created_at, acknowledged_at (if set), resolved_at (if set), escalation info from context_data
3. **Action buttons** (admin/manager only, hidden for viewer):
   - "Acknowledge" button (only if status='pending'): Updates alert status to 'acknowledged', sets acknowledged_at=now(), acknowledged_by=userId. Uses Supabase update.
   - "Dismiss" button (only if status='pending' or 'acknowledged'): Updates status to 'dismissed'.
   - "Resolve" button (only if status='pending' or 'acknowledged'): Updates status to 'resolved', sets resolved_at=now().
4. Show toast (sonner or shadcn toast) on successful action. Call onAction() to refresh the parent list.

**alerts/page.tsx:**

Server component page at /alerts route.

1. Get user session and extract org_id, user role, user id
2. Initial fetch of alerts (server-side) for SSR
3. Render page title "Alert History" with description "Monitor and manage triggered alerts"
4. Render AlertList component with orgId, userRole, userId props
5. Add navigation: tab or link to "Alert Rules" (/alerts/rules) at the top of the page so users can navigate between history and rule configuration

**Sidebar navigation update:** If the Phase 3 sidebar component exists at dashboard/src/components/layout/sidebar.tsx, add an "Alerts" nav item linking to /alerts with a bell icon. If the sidebar doesn't exist yet (Phase 3 not executed), note this in comments as a TODO.
  </action>
  <verify>
- alert-list.tsx fetches alerts with joined ad_accounts and alert_rules data
- Uses useRealtime hook for live alert updates
- Displays severity, title, account, rule, status, time columns
- Has severity and status filter controls
- alert-detail-dialog.tsx shows full alert details including delivery history
- Has acknowledge, dismiss, resolve action buttons (admin/manager only)
- Updates alert status via Supabase on action
- alerts/page.tsx is a valid Next.js page at /alerts
- Role check hides action buttons for viewers
  </verify>
  <done>
Alert history page at /alerts displays all alerts in a filterable, sortable DataTable with real-time updates. Clicking an alert opens a detail dialog showing full context, delivery history, and action buttons (acknowledge/dismiss/resolve) for admin/manager users. Acknowledging an alert stops escalation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification channel configuration page</name>
  <files>
dashboard/src/components/notifications/channel-form.tsx
dashboard/src/components/notifications/channel-list.tsx
dashboard/src/app/(dashboard)/settings/notifications/page.tsx
  </files>
  <action>
**channel-form.tsx:**

Form component for adding/editing notification channels.

Props:
- `mode: 'create' | 'edit'`
- `initialValues?: Partial<NotificationChannelFormValues>`
- `onSubmit: (values: NotificationChannelFormValues) => Promise<void>`
- `onCancel: () => void`

Form fields:
1. Name (Input): descriptive name for the channel (e.g., "Ops Team Email", "Telegram Alerts Group")
2. Channel Type (Select): 'email' or 'telegram' (whatsapp deferred to Phase 5)
3. Min Severity (Select): info/warning/critical/emergency -- minimum severity to receive on this channel
4. Is Enabled (Switch): toggle channel on/off
5. Active Hours section:
   - Checkbox: "Enable quiet hours"
   - If enabled: start time (Input type="time"), end time (Input type="time"), timezone (pre-filled with "Africa/Cairo", editable)
   - Explain: "Notifications will be suppressed during quiet hours except for emergency alerts"
6. **Dynamic config based on channel_type:**
   - email: Recipients (Textarea, one email per line, or comma-separated). Parse into string array on submit. Validate each is a valid email format.
   - telegram: Chat ID (Input, string). Help text: "Group chat IDs start with -100. Use @BotFather to get your chat ID."

Validate with Zod:
```typescript
const channelFormSchema = z.object({
  name: z.string().min(2).max(100),
  channel_type: z.enum(['email', 'telegram']),
  min_severity: z.enum(['info', 'warning', 'critical', 'emergency']),
  is_enabled: z.boolean().default(true),
  active_hours: z.object({
    start: z.string(),
    end: z.string(),
    timezone: z.string().default('Africa/Cairo'),
  }).nullable().optional(),
  config: z.record(z.unknown()),
})
```

Render in a Dialog.

**channel-list.tsx:**

List component displaying configured notification channels.

Props:
- `orgId: string`
- `userRole: 'admin' | 'manager' | 'viewer'`

Behavior:
1. Fetch notification_channels from Supabase where org_id=orgId, ordered by created_at ASC
2. Display as cards (not a data table -- channels are few, cards look better):
   - Channel icon (email icon or telegram icon based on channel_type)
   - Name
   - Channel type label
   - Min severity (SeverityBadge)
   - Status: enabled/disabled badge
   - Quiet hours info (if configured): "Quiet: 00:00-08:00 Cairo"
   - Config summary: for email show recipient count ("3 recipients"), for telegram show chat_id
3. Enable/disable toggle (admin/manager only): Switch to toggle is_enabled
4. Edit button (admin/manager only): Opens ChannelForm in edit mode
5. Delete button (admin/manager only): Confirmation dialog then DELETE from notification_channels
6. "Add Channel" button at top (admin/manager only): Opens ChannelForm in create mode
7. On form submit (create): INSERT into notification_channels with org_id
8. On form submit (edit): UPDATE notification_channels WHERE id=channel.id

**settings/notifications/page.tsx:**

Server component page at /settings/notifications route.

1. Get user session and extract org_id, user role
2. Render page title "Notification Channels" with description "Configure where alert notifications are delivered"
3. Render ChannelList with orgId, userRole props
4. If no channels exist, show an empty state: "No notification channels configured. Add an email or Telegram channel to start receiving alerts."

**Note:** The existing seed data (Phase 1) already created a default email channel for targetspro org with recipients ["info@targetspro.com"]. This should appear in the list.
  </action>
  <verify>
- channel-form.tsx exports ChannelForm with mode, initialValues, onSubmit, onCancel props
- Has dynamic config fields for email (recipients textarea) and telegram (chat_id input)
- Has quiet hours configuration with start/end/timezone
- Validates with Zod schema
- channel-list.tsx exports ChannelList that fetches and displays channels as cards
- Has enable/disable toggle, edit, delete functionality
- Role-based access hides controls for viewers
- settings/notifications/page.tsx is a valid Next.js page at /settings/notifications
- Shows the seeded default email channel for targetspro
  </verify>
  <done>
Notification channel management page at /settings/notifications displays configured channels as cards with enable/disable toggles, edit/delete actions, and quiet hours info. Users can add email channels (with recipients list) and telegram channels (with chat_id). The seeded default email channel appears in the list. Admin/manager can CRUD channels; viewer sees read-only view.
  </done>
</task>

</tasks>

<verification>
- Alert history page shows real-time alert updates
- Alert detail dialog shows full context including delivery history
- Acknowledge action updates alert status and stops escalation
- Notification channels page shows the seeded default email channel
- Channel form validates email addresses and telegram chat IDs
- Quiet hours configuration stores timezone (Africa/Cairo by default)
- Emergency alerts note in quiet hours UI explains bypass behavior
- Role-based access throughout: viewer = read-only
</verification>

<success_criteria>
- /alerts page lists alerts with severity badges, filtering by severity/status
- Clicking an alert shows details + delivery history in dialog
- Acknowledge button sets status to 'acknowledged' with timestamp
- /settings/notifications page shows default email channel from seed data
- Admin can add a telegram channel with chat_id
- All pages respect role-based access control
</success_criteria>

<output>
After completion, create `.planning/phases/04-alert-engine-email-telegram/04-04-SUMMARY.md`
</output>
