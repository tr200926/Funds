---
phase: 03-dashboard-mvp-nextjs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/package.json
  - dashboard/tsconfig.json
  - dashboard/next.config.ts
  - dashboard/tailwind.config.ts
  - dashboard/components.json
  - dashboard/src/app/layout.tsx
  - dashboard/src/app/page.tsx
  - dashboard/src/app/loading.tsx
  - dashboard/src/app/error.tsx
  - dashboard/src/app/not-found.tsx
  - dashboard/src/app/(auth)/login/page.tsx
  - dashboard/src/app/(auth)/layout.tsx
  - dashboard/src/app/auth/callback/route.ts
  - dashboard/src/app/(dashboard)/layout.tsx
  - dashboard/src/app/(dashboard)/loading.tsx
  - dashboard/src/middleware.ts
  - dashboard/src/lib/supabase/client.ts
  - dashboard/src/lib/supabase/server.ts
  - dashboard/src/lib/supabase/middleware.ts
  - dashboard/src/lib/database.types.ts
  - dashboard/src/lib/utils.ts
  - dashboard/src/lib/format.ts
  - dashboard/src/hooks/use-user.ts
  - dashboard/src/hooks/use-realtime.ts
  - dashboard/src/components/layout/sidebar.tsx
  - dashboard/src/components/layout/header.tsx
  - dashboard/src/components/layout/mobile-nav.tsx
  - dashboard/src/components/auth/login-form.tsx
  - dashboard/.env.local.example
  - supabase/migrations/20260212100000_enable_realtime.sql
autonomous: true

user_setup:
  - service: supabase
    why: "Dashboard needs Supabase project URL and anon key for auth and data access"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> Project API keys -> anon/public"

must_haves:
  truths:
    - "Next.js dev server starts without errors at localhost:3000"
    - "Unauthenticated users are redirected to /login"
    - "Login page renders with email/password form"
    - "Authenticated users see dashboard layout with sidebar navigation"
    - "Supabase Realtime publication includes ad_accounts, alerts, pipeline_runs tables"
  artifacts:
    - path: "dashboard/src/lib/supabase/client.ts"
      provides: "Browser Supabase client factory"
      contains: "createBrowserClient"
    - path: "dashboard/src/lib/supabase/server.ts"
      provides: "Server Supabase client factory"
      contains: "createServerClient"
    - path: "dashboard/src/middleware.ts"
      provides: "Auth middleware with token refresh"
      contains: "getClaims"
    - path: "dashboard/src/lib/format.ts"
      provides: "Financial value parsing and Cairo timezone formatting"
      exports: ["parseNumeric", "formatCurrency", "formatCairoDate", "formatRelativeTime", "calcTimeToDepletion"]
    - path: "dashboard/src/hooks/use-realtime.ts"
      provides: "Supabase Realtime subscription hook"
      contains: "postgres_changes"
    - path: "supabase/migrations/20260212100000_enable_realtime.sql"
      provides: "Realtime publication for dashboard tables"
      contains: "ALTER PUBLICATION supabase_realtime"
  key_links:
    - from: "dashboard/src/middleware.ts"
      to: "dashboard/src/lib/supabase/middleware.ts"
      via: "import createClient from middleware helper"
      pattern: "import.*supabase/middleware"
    - from: "dashboard/src/app/(auth)/login/page.tsx"
      to: "dashboard/src/components/auth/login-form.tsx"
      via: "renders LoginForm component"
      pattern: "LoginForm"
    - from: "dashboard/src/app/(dashboard)/layout.tsx"
      to: "dashboard/src/components/layout/sidebar.tsx"
      via: "renders Sidebar in layout"
      pattern: "Sidebar"
---

<objective>
Scaffold the Next.js 15 dashboard application with Supabase SSR auth, dashboard layout shell, shared utilities, and Realtime infrastructure.

Purpose: This is the foundation every other dashboard plan depends on. It establishes the Next.js project structure, the three Supabase client factories (browser/server/middleware) for SSR auth, the login flow, the dashboard layout with sidebar navigation, shared formatting utilities for financial values and Cairo timezone dates, the Realtime subscription hook, and the SQL migration enabling Realtime on dashboard-critical tables.

Output: A working Next.js app at `dashboard/` with auth-protected routes, login page, dashboard layout shell, and all shared infrastructure ready for feature plans.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-mvp-nextjs/03-RESEARCH.md
@lib/database.types.ts
@lib/supabase.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 app and install all dependencies</name>
  <files>
    dashboard/package.json
    dashboard/tsconfig.json
    dashboard/next.config.ts
    dashboard/.env.local.example
    dashboard/src/lib/database.types.ts
    dashboard/src/lib/utils.ts
    dashboard/src/lib/format.ts
  </files>
  <action>
1. Create the Next.js app as a subdirectory (the root package.json manages pipeline scripts separately):

```bash
npx create-next-app@latest dashboard --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
```

Accept all defaults. This creates `dashboard/` with Next.js 15, React 19, Tailwind v4, TypeScript.

2. Install additional dependencies inside `dashboard/`:

```bash
cd dashboard
npm install @supabase/ssr @supabase/supabase-js recharts date-fns @tanstack/react-table
```

3. Initialize shadcn/ui:

```bash
npx shadcn@latest init
```

Use defaults (New York style, zinc base color). This adds `components.json`, `tw-animate-css`, `clsx`, `class-variance-authority`, `lucide-react`, and the `cn()` utility.

4. Add required shadcn components:

```bash
npx shadcn@latest add table card badge button input select dropdown-menu dialog tabs separator skeleton avatar sheet
```

5. Copy `lib/database.types.ts` from root into `dashboard/src/lib/database.types.ts`. Keep the root copy unchanged (used by pipeline scripts). Do NOT symlink -- copy the full file. Include the `Tables`, `Insert`, `Update` type helpers at the bottom.

6. Create `dashboard/src/lib/format.ts` with these exports (use the exact implementations from the research doc):
   - `parseNumeric(value: string | null | undefined): number` -- parse NUMERIC strings to numbers, return 0 for null/undefined/NaN
   - `formatCurrency(value: string | null | undefined, currency?: string): string` -- format using Intl.NumberFormat with 'en-US' locale, default currency 'EGP'
   - `formatCairoDate(date: string | Date, options?: Intl.DateTimeFormatOptions): string` -- ALWAYS use timeZone: 'Africa/Cairo' (per project decision #4)
   - `formatRelativeTime(date: string | Date): string` -- "5m ago", "2h ago", "3d ago", "Just now"
   - `calcTimeToDepletion(balance: string | null | undefined, dailySpend: string | null | undefined): number | null` -- returns days, null if spend <= 0 or balance <= 0

7. Create `dashboard/.env.local.example` with:
```
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

8. Ensure `dashboard/tsconfig.json` has `"strict": true` (R4.1 requirement). The `create-next-app` template should already have this, but verify and add if missing.

IMPORTANT: The `dashboard/src/lib/utils.ts` will be created by `shadcn init` with the `cn()` helper. Do NOT overwrite it.
  </action>
  <verify>
Run from dashboard directory:
- `cd dashboard && npm run build` compiles without errors (may have "no pages" warnings -- that is OK at this stage)
- `npx tsc --noEmit` passes with strict mode
- Verify `dashboard/src/lib/format.ts` exports all 5 functions
- Verify `dashboard/src/lib/database.types.ts` contains the `Database` type and `Tables` helper
- Verify `dashboard/components.json` exists (shadcn initialized)
  </verify>
  <done>
Next.js 15 project exists at `dashboard/` with all dependencies installed (supabase-js, ssr, recharts, date-fns, tanstack-table, shadcn components). TypeScript strict mode enabled. Database types and formatting utilities in place. shadcn/ui initialized with all required components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Supabase SSR auth with three client factories, middleware, and login flow</name>
  <files>
    dashboard/src/lib/supabase/client.ts
    dashboard/src/lib/supabase/server.ts
    dashboard/src/lib/supabase/middleware.ts
    dashboard/src/middleware.ts
    dashboard/src/app/auth/callback/route.ts
    dashboard/src/app/(auth)/layout.tsx
    dashboard/src/app/(auth)/login/page.tsx
    dashboard/src/components/auth/login-form.tsx
    dashboard/src/hooks/use-user.ts
  </files>
  <action>
1. Create three Supabase client factories following the exact patterns from the research doc:

   **`dashboard/src/lib/supabase/client.ts`** (browser client):
   - `'use client'` directive at top
   - Export `function createClient()` that calls `createBrowserClient<Database>()` from `@supabase/ssr`
   - Uses `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` env vars

   **`dashboard/src/lib/supabase/server.ts`** (server client):
   - Export `async function createClient()` that calls `createServerClient<Database>()` from `@supabase/ssr`
   - Uses `await cookies()` from `next/headers` for cookie handling
   - The `setAll` catch block is intentional (Server Components cannot set cookies)

   **`dashboard/src/lib/supabase/middleware.ts`** (middleware helper):
   - Export `async function updateSession(request: NextRequest)` that creates a server client with request/response cookie bridging
   - Calls `supabase.auth.getUser()` to refresh the session token on every request
   - IMPORTANT: Use `getUser()` in middleware (not `getClaims()`) because `getUser()` is the standard middleware pattern that triggers token refresh. Use `getClaims()` in server components for auth checks.
   - Redirects unauthenticated users to `/login` (except for `/login`, `/auth`, static assets)
   - Returns the response with updated cookies

2. Create `dashboard/src/middleware.ts`:
   - Import and call `updateSession()` from the middleware helper
   - Export config with matcher that excludes `_next/static`, `_next/image`, `favicon.ico`, and common image extensions

3. Create auth callback route `dashboard/src/app/auth/callback/route.ts`:
   - Handle GET request with `code` search param
   - Exchange code for session using `supabase.auth.exchangeCodeForSession(code)`
   - Redirect to `/overview` on success, `/login?error=auth` on failure

4. Create auth layout `dashboard/src/app/(auth)/layout.tsx`:
   - Simple centered layout (no sidebar), just children in a centered flex container
   - Used for login page only

5. Create login page `dashboard/src/app/(auth)/login/page.tsx`:
   - Server component that checks if user is already authenticated (redirect to /overview if so)
   - Renders the LoginForm client component

6. Create `dashboard/src/components/auth/login-form.tsx`:
   - `'use client'` component
   - Email + password form fields using shadcn Input and Button components
   - Calls `supabase.auth.signInWithPassword({ email, password })` on submit
   - Shows error message on invalid credentials using a simple red text div
   - Redirects to `/overview` on successful login using `router.push('/overview')` then `router.refresh()`
   - No sign-up form needed (users are provisioned by admin via Supabase dashboard)

7. Create `dashboard/src/hooks/use-user.ts`:
   - `'use client'` hook
   - Returns `{ user, role, orgId, isLoading }` where role is read from `user.app_metadata?.role` (synced by Phase 1 trigger `update_user_role_claim`)
   - Subscribes to `onAuthStateChange` for reactive updates
   - Role type: `'admin' | 'manager' | 'viewer'`, default to `'viewer'`
   - Clean up subscription on unmount

CRITICAL ANTI-PATTERNS TO AVOID:
- Do NOT use `getSession()` for auth checks in server components -- use `getClaims()` which validates JWT signatures
- Do NOT create a singleton Supabase client at module level for server contexts -- always use factory functions
- Do NOT use the deprecated `@supabase/auth-helpers-nextjs` package
  </action>
  <verify>
- `cd dashboard && npx tsc --noEmit` passes (all auth files type-check)
- Verify `dashboard/src/middleware.ts` imports from `./lib/supabase/middleware`
- Verify `dashboard/src/lib/supabase/client.ts` has `'use client'` directive
- Verify `dashboard/src/lib/supabase/server.ts` uses `await cookies()`
- Verify `dashboard/src/components/auth/login-form.tsx` calls `signInWithPassword`
- `cd dashboard && npm run build` succeeds
  </verify>
  <done>
Three Supabase client factories (browser, server, middleware) correctly implement the SSR auth pattern. Middleware refreshes tokens on every request and redirects unauthenticated users. Login page with email/password form works with Supabase Auth. Auth callback route handles code exchange. useUser hook provides role-based access info from JWT app_metadata.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard layout shell with sidebar, header, mobile nav, and Realtime migration</name>
  <files>
    dashboard/src/app/layout.tsx
    dashboard/src/app/page.tsx
    dashboard/src/app/loading.tsx
    dashboard/src/app/error.tsx
    dashboard/src/app/not-found.tsx
    dashboard/src/app/(dashboard)/layout.tsx
    dashboard/src/app/(dashboard)/loading.tsx
    dashboard/src/components/layout/sidebar.tsx
    dashboard/src/components/layout/header.tsx
    dashboard/src/components/layout/mobile-nav.tsx
    dashboard/src/hooks/use-realtime.ts
    supabase/migrations/20260212100000_enable_realtime.sql
  </files>
  <action>
1. Update `dashboard/src/app/layout.tsx` (root layout):
   - Set metadata: title "Targetspro Dashboard", description "Ad spend monitoring dashboard"
   - Import global CSS (Tailwind)
   - Render children with Inter font (default from create-next-app)

2. Create `dashboard/src/app/page.tsx`:
   - Server component that redirects to `/overview` using `redirect('/overview')` from `next/navigation`
   - This ensures the root URL goes to the main dashboard page

3. Create `dashboard/src/app/loading.tsx` -- full page skeleton with centered spinner

4. Create `dashboard/src/app/error.tsx`:
   - `'use client'` error boundary
   - Show error message and a "Try again" button that calls `reset()`

5. Create `dashboard/src/app/not-found.tsx` -- simple 404 page with link back to /overview

6. Create `dashboard/src/app/(dashboard)/layout.tsx`:
   - Server component that wraps all dashboard pages
   - Verifies auth via `getClaims()` on the server client -- redirect to `/login` if not authenticated
   - Layout structure: sidebar on the left (hidden on mobile), main content area on the right
   - Desktop: fixed sidebar (w-64) + main content area with header at top
   - Mobile: no visible sidebar, header with hamburger menu that opens Sheet (mobile nav)
   - Pass user role to Sidebar and Header (fetched from getClaims)

7. Create `dashboard/src/app/(dashboard)/loading.tsx` -- dashboard-specific loading skeleton with sidebar placeholder + content skeleton

8. Create `dashboard/src/components/layout/sidebar.tsx`:
   - `'use client'` component (needs to track active route)
   - Navigation links using Next.js `Link` component:
     - Overview (/overview) -- LayoutDashboard icon
     - Pipeline (/pipeline) -- Activity icon
   - Highlight active link based on `usePathname()`
   - Show org name "Targetspro" at top
   - User role badge at bottom (viewer/manager/admin) using shadcn Badge
   - Use lucide-react icons

9. Create `dashboard/src/components/layout/header.tsx`:
   - Shows page title area
   - Right side: user avatar/initial with dropdown (shadcn DropdownMenu)
   - Dropdown options: role display (non-clickable), separator, Sign Out (calls `supabase.auth.signOut()` then `router.push('/login')`)
   - On mobile (lg:hidden): show hamburger button that triggers mobile nav Sheet

10. Create `dashboard/src/components/layout/mobile-nav.tsx`:
    - Uses shadcn Sheet component (slides in from left)
    - Same navigation links as sidebar
    - Closes on link click
    - Accepts `open` and `onOpenChange` props

11. Create `dashboard/src/hooks/use-realtime.ts`:
    - Generic Realtime subscription hook following the exact pattern from research doc
    - Takes `{ table, schema?, event?, filter?, onInsert?, onUpdate?, onDelete?, onChange? }` options
    - Creates a Supabase channel with `postgres_changes` subscription
    - Returns channelRef
    - Cleans up via `supabase.removeChannel(channel)` on unmount
    - Dependencies: [table, schema, event, filter] in useEffect deps array

12. Create `supabase/migrations/20260212100000_enable_realtime.sql`:
    - `ALTER PUBLICATION supabase_realtime ADD TABLE ad_accounts;`
    - `ALTER PUBLICATION supabase_realtime ADD TABLE alerts;`
    - `ALTER PUBLICATION supabase_realtime ADD TABLE pipeline_runs;`
    - This enables Realtime subscriptions for the dashboard (R4.5). Without this, subscriptions succeed silently but never fire.

RESPONSIVE DESIGN NOTES (R4.8):
- Desktop-first: sidebar visible at lg+ breakpoint (1024px+)
- Mobile: sidebar hidden, hamburger menu in header opens Sheet overlay
- Use Tailwind responsive prefixes: `hidden lg:flex` for sidebar, `lg:hidden` for hamburger
  </action>
  <verify>
- `cd dashboard && npm run build` succeeds without errors
- `cd dashboard && npm run dev` starts and shows the app at localhost:3000
- Verify the root page redirects to /overview (which will 404 until Plan 02 creates it -- that is expected)
- Verify `/login` page renders (manually navigate to localhost:3000/login)
- Verify `supabase/migrations/20260212100000_enable_realtime.sql` exists with ALTER PUBLICATION statements
- `npx tsc --noEmit` in dashboard directory passes
  </verify>
  <done>
Dashboard layout shell is complete with responsive sidebar (desktop) and Sheet-based mobile nav. Auth-protected dashboard route group redirects unauthenticated users. Root URL redirects to /overview. Error boundary, loading states, and 404 page provide polish. Realtime subscription hook is ready for feature components. Supabase Realtime publication migration enables postgres_changes on ad_accounts, alerts, and pipeline_runs tables.
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` -- full production build succeeds
2. `cd dashboard && npx tsc --noEmit` -- TypeScript strict mode passes
3. `cd dashboard && npm run dev` -- dev server starts at localhost:3000
4. Navigate to localhost:3000 -- redirects to /login (if not authenticated) or /overview
5. Login page renders with email/password form
6. `supabase/migrations/20260212100000_enable_realtime.sql` contains ALTER PUBLICATION for 3 tables
7. All shadcn components installed: table, card, badge, button, input, select, dropdown-menu, dialog, tabs, separator, skeleton, avatar, sheet
</verification>

<success_criteria>
- Next.js 15 app at `dashboard/` with TypeScript strict mode
- Supabase SSR auth fully wired (3 client factories + middleware + login)
- Dashboard layout with responsive sidebar and mobile nav
- Shared utilities: format.ts (financial + Cairo timezone), use-realtime.ts hook, use-user.ts hook
- Database types copied into dashboard
- Realtime publication migration ready to deploy
- Build succeeds, dev server runs
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-mvp-nextjs/03-01-SUMMARY.md`
</output>
