---
phase: 03-dashboard-mvp-nextjs
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - dashboard/src/app/(dashboard)/overview/page.tsx
  - dashboard/src/app/(dashboard)/overview/loading.tsx
  - dashboard/src/components/accounts/accounts-overview.tsx
  - dashboard/src/components/accounts/accounts-table.tsx
  - dashboard/src/components/accounts/columns.tsx
  - dashboard/src/components/accounts/account-filters.tsx
autonomous: true

must_haves:
  truths:
    - "User sees all ad accounts in a sortable table with name, platform, balance, daily spend, MTD spend, status, days-left, last sync"
    - "User can filter accounts by platform (Facebook/TikTok), status (active/paused/disabled), and business manager"
    - "Table data updates in real-time when ad_accounts rows change in the database (no page refresh)"
    - "Financial values display correctly as formatted currency (EGP), not raw strings"
    - "Time-to-depletion shows colored badges (red <=3d, yellow <=7d)"
  artifacts:
    - path: "dashboard/src/app/(dashboard)/overview/page.tsx"
      provides: "Server component fetching all ad_accounts with platform join"
      contains: "createClient"
    - path: "dashboard/src/components/accounts/accounts-overview.tsx"
      provides: "Client wrapper with Realtime subscription"
      contains: "useRealtime"
    - path: "dashboard/src/components/accounts/accounts-table.tsx"
      provides: "TanStack DataTable rendering with sorting, filtering"
      contains: "useReactTable"
    - path: "dashboard/src/components/accounts/columns.tsx"
      provides: "Column definitions with formatCurrency, calcTimeToDepletion"
      contains: "ColumnDef"
    - path: "dashboard/src/components/accounts/account-filters.tsx"
      provides: "Platform, status, and business manager filter controls"
      contains: "Select"
  key_links:
    - from: "dashboard/src/app/(dashboard)/overview/page.tsx"
      to: "supabase.from('ad_accounts')"
      via: "server-side data fetch"
      pattern: "from\\('ad_accounts'\\)"
    - from: "dashboard/src/components/accounts/accounts-overview.tsx"
      to: "dashboard/src/hooks/use-realtime.ts"
      via: "useRealtime hook for live updates"
      pattern: "useRealtime.*ad_accounts"
    - from: "dashboard/src/components/accounts/columns.tsx"
      to: "dashboard/src/lib/format.ts"
      via: "formatCurrency and calcTimeToDepletion for display"
      pattern: "formatCurrency|calcTimeToDepletion"
    - from: "dashboard/src/components/accounts/accounts-table.tsx"
      to: "dashboard/src/components/accounts/columns.tsx"
      via: "imports column definitions"
      pattern: "import.*columns"
---

<objective>
Build the unified account overview page (R4.2) with sortable DataTable, platform/status/BM filters (R4.4), and real-time updates via Supabase Realtime (R4.5).

Purpose: This is the primary dashboard page users will see. It shows every ad account across Facebook and TikTok with current financial metrics, status, and time-to-depletion. Real-time subscriptions ensure the data stays fresh without manual page refreshes.

Output: Working /overview page with a fully functional accounts table that sorts, filters, and updates live.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-mvp-nextjs/03-RESEARCH.md
@.planning/phases/03-dashboard-mvp-nextjs/03-01-SUMMARY.md
@dashboard/src/lib/database.types.ts
@dashboard/src/lib/format.ts
@dashboard/src/hooks/use-realtime.ts
@dashboard/src/lib/supabase/server.ts
@dashboard/src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create overview page with server-side data fetching and column definitions</name>
  <files>
    dashboard/src/app/(dashboard)/overview/page.tsx
    dashboard/src/app/(dashboard)/overview/loading.tsx
    dashboard/src/components/accounts/columns.tsx
  </files>
  <action>
1. Create `dashboard/src/app/(dashboard)/overview/page.tsx`:
   - Server component (NO 'use client')
   - Use `createClient()` from `@/lib/supabase/server`
   - Verify auth with `getClaims()` -- redirect to `/login` if no claims
   - Query ad_accounts with platform join:
     ```
     supabase.from('ad_accounts')
       .select('*, platforms(display_name)')
       .neq('status', 'archived')
       .order('account_name')
     ```
   - RLS automatically scopes to user's org (no manual org_id filter needed)
   - Use `Promise.all()` if fetching additional summary data (not needed for MVP -- just accounts)
   - Pass `initialData` to `AccountsOverview` client component
   - Handle fetch errors by throwing (caught by error.tsx boundary)

2. Create `dashboard/src/app/(dashboard)/overview/loading.tsx`:
   - Show a skeleton table using shadcn Skeleton components
   - Render 3 skeleton filter bars at top + 8 skeleton table rows
   - Use appropriate widths to match the real table layout

3. Create `dashboard/src/components/accounts/columns.tsx`:
   - `'use client'` directive
   - Import `ColumnDef` from `@tanstack/react-table`
   - Import `formatCurrency`, `calcTimeToDepletion`, `formatRelativeTime` from `@/lib/format`
   - Import Badge, Button from shadcn/ui

   Define columns for the ad_accounts table (following the research doc pattern):

   a. **Platform** (`platform_id`): Badge with "FB" for facebook, "TT" for tiktok. Filterable.
   b. **Account Name** (`account_name`): Sortable header with ArrowUpDown icon. Render as a Next.js Link to `/accounts/{id}` for navigation to detail page.
   c. **Business Manager** (`business_manager`): Plain text. Filterable.
   d. **Balance** (`current_balance`): Sortable. Cell renders `formatCurrency(value, row.original.currency)`. Custom `sortingFn` that parses string to float for numeric sorting.
   e. **Daily Spend** (`current_daily_spend`): Cell renders `formatCurrency(value, row.original.currency)`.
   f. **MTD Spend** (`current_mtd_spend`): Cell renders `formatCurrency(value, row.original.currency)`.
   g. **Status** (`status`): Badge with color coding: green for active, yellow for paused, red for disabled.
   h. **Days Left** (computed from `current_balance` and `current_daily_spend`): Call `calcTimeToDepletion()`. Show destructive Badge if <= 3 days, secondary Badge if <= 7 days, plain text otherwise. Show "--" if null.
   i. **Last Sync** (`last_synced_at`): Call `formatRelativeTime()`. Show "Never" if null.

   Export `columns` array as `ColumnDef<AdAccountWithPlatform>[]` where `AdAccountWithPlatform` extends the base `ad_accounts` Row type with the joined `platforms` data.

   IMPORTANT: All financial columns (balance, daily spend, MTD spend) come as `string | null` from the database types. Use `formatCurrency()` which handles the string-to-number conversion internally. For sorting, use custom `sortingFn` that calls `parseFloat` on the string values.
  </action>
  <verify>
- `cd dashboard && npx tsc --noEmit` passes
- Verify `columns.tsx` exports a `columns` array
- Verify `overview/page.tsx` uses `getClaims()` for auth check
- Verify all financial columns use `formatCurrency()` not raw display
  </verify>
  <done>
Overview page fetches ad_accounts from Supabase with platform join in a server component. Column definitions handle all R4.2 fields (name, platform, balance, daily spend, MTD spend, status, time-to-depletion, last sync) with proper financial formatting and sorting. Loading skeleton provides visual feedback during data fetch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DataTable with filters and Realtime subscription wrapper</name>
  <files>
    dashboard/src/components/accounts/accounts-table.tsx
    dashboard/src/components/accounts/accounts-overview.tsx
    dashboard/src/components/accounts/account-filters.tsx
  </files>
  <action>
1. Create `dashboard/src/components/accounts/accounts-table.tsx`:
   - `'use client'` component
   - Props: `{ data: AdAccountWithPlatform[], columns: ColumnDef[] }`
   - Use `useReactTable` from `@tanstack/react-table` with:
     - `getCoreRowModel()`
     - `getSortedRowModel()` with `sorting` state
     - `getFilteredRowModel()` with `columnFilters` state
     - `getPaginationRowModel()` (show 25 rows per page)
   - Render using shadcn Table components (Table, TableHeader, TableRow, TableHead, TableBody, TableCell)
   - Show "No accounts found" message for empty filtered results
   - Add pagination controls at bottom (Previous/Next buttons with page count)
   - Render `AccountFilters` component above the table, passing the table instance for filter control

2. Create `dashboard/src/components/accounts/account-filters.tsx`:
   - `'use client'` component
   - Props: `{ table: Table<AdAccountWithPlatform> }`
   - Three filter controls in a horizontal row (flex, gap-4, wrap on mobile):

   a. **Platform filter**: shadcn Select with options: All, Facebook, TikTok. Sets column filter on `platform_id`.
   b. **Status filter**: shadcn Select with options: All, Active, Paused, Disabled. Sets column filter on `status`.
   c. **Business Manager filter**: shadcn Select populated dynamically from unique `business_manager` values in the table data. Options: All + each unique BM name. Sets column filter on `business_manager`.

   - "Clear Filters" button that resets all column filters when any filter is active
   - Show active filter count badge

3. Create `dashboard/src/components/accounts/accounts-overview.tsx`:
   - `'use client'` component
   - Props: `{ initialData: AdAccountWithPlatform[] }`
   - Manages `accounts` state initialized from `initialData`
   - Subscribes to Realtime updates using the `useRealtime` hook from Plan 01:
     ```
     useRealtime<AdAccount>({
       table: 'ad_accounts',
       event: '*',
       onUpdate: useCallback(({ new: updated }) => {
         setAccounts(prev => prev.map(a => a.id === updated.id ? { ...a, ...updated } : a))
       }, []),
       onInsert: useCallback((inserted) => {
         setAccounts(prev => [...prev, inserted])
       }, []),
       onDelete: useCallback((deleted) => {
         setAccounts(prev => prev.filter(a => a.id !== deleted.id))
       }, []),
     })
     ```
   - Wraps useCallback around all handlers to prevent re-subscription on every render
   - Renders `<AccountsTable data={accounts} columns={columns} />`
   - Import columns from `./columns`

RESPONSIVE DESIGN (R4.8):
- Filters wrap to new lines on mobile (flex-wrap)
- Table has horizontal scroll on narrow screens (`overflow-x-auto`)
- Account name column has min-width to stay readable
  </action>
  <verify>
- `cd dashboard && npx tsc --noEmit` passes
- `cd dashboard && npm run build` succeeds
- Verify `accounts-overview.tsx` calls `useRealtime` with table: 'ad_accounts'
- Verify `accounts-table.tsx` uses `useReactTable` with sorting, filtering, pagination
- Verify `account-filters.tsx` has platform, status, and business manager Select components
  </verify>
  <done>
Unified account overview page is complete with:
- TanStack-powered DataTable with sorting on all key columns (R4.2)
- Platform, status, and business manager filter controls (R4.4)
- Real-time updates via Supabase Realtime -- table updates automatically when ad_accounts change (R4.5)
- Responsive horizontal scroll on mobile (R4.8)
- Pagination for large account lists (25 per page)
- Financial values properly formatted via formatCurrency
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` -- production build succeeds
2. Navigate to /overview after logging in -- see all non-archived accounts in a table
3. Click column headers -- sorting works (ascending/descending toggle)
4. Use platform filter -- table shows only Facebook or TikTok accounts
5. Use status filter -- table shows only active/paused/disabled accounts
6. Use BM filter -- table shows only accounts from selected business manager
7. Balance and spend columns display formatted EGP currency values
8. "Days Left" column shows colored badges for accounts at risk
9. Click account name -- navigates to /accounts/{id} (page may not exist yet until Plan 03)
</verification>

<success_criteria>
- /overview renders all ad accounts in a sortable DataTable
- All R4.2 columns present: name, platform, balance, daily spend, MTD spend, status, TTD, last sync
- R4.4 filters work: platform, status, business manager with clear option
- R4.5 real-time: table rows update when database changes (no refresh needed)
- Financial values display as formatted EGP currency
- Responsive: horizontal scroll on mobile, filter wrap
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-mvp-nextjs/03-02-SUMMARY.md`
</output>
