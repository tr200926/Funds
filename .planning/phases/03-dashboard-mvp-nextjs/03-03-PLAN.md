---
phase: 03-dashboard-mvp-nextjs
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - dashboard/src/app/(dashboard)/accounts/[id]/page.tsx
  - dashboard/src/app/(dashboard)/accounts/[id]/loading.tsx
  - dashboard/src/components/charts/spend-chart.tsx
  - dashboard/src/components/charts/balance-chart.tsx
  - dashboard/src/components/charts/chart-wrapper.tsx
  - dashboard/src/app/(dashboard)/pipeline/page.tsx
  - dashboard/src/app/(dashboard)/pipeline/loading.tsx
  - dashboard/src/components/pipeline/pipeline-table.tsx
autonomous: true

must_haves:
  truths:
    - "User can click an account name and see a detail page with spend trend chart, balance history chart, funding source info, and alert history"
    - "Spend trend chart shows daily spend over time as an area chart with formatted currency axis"
    - "Balance history chart shows balance over time as a line chart"
    - "Alert history section shows past alerts for this account with severity, title, message, and timestamp"
    - "User can view pipeline health page showing workflow run history with pipeline name, status, timing, and error counts"
    - "Pipeline runs update in real-time when new runs complete"
  artifacts:
    - path: "dashboard/src/app/(dashboard)/accounts/[id]/page.tsx"
      provides: "Account detail server component fetching spend_records, balance_snapshots, alerts"
      contains: "Promise.all"
    - path: "dashboard/src/components/charts/spend-chart.tsx"
      provides: "Recharts AreaChart for daily spend trend"
      contains: "AreaChart"
    - path: "dashboard/src/components/charts/balance-chart.tsx"
      provides: "Recharts LineChart for balance history"
      contains: "LineChart"
    - path: "dashboard/src/app/(dashboard)/pipeline/page.tsx"
      provides: "Pipeline health server component fetching pipeline_runs"
      contains: "from('pipeline_runs')"
    - path: "dashboard/src/components/pipeline/pipeline-table.tsx"
      provides: "Pipeline runs table with realtime updates"
      contains: "useRealtime"
  key_links:
    - from: "dashboard/src/app/(dashboard)/accounts/[id]/page.tsx"
      to: "supabase.from('spend_records')"
      via: "server-side fetch for chart data"
      pattern: "from\\('spend_records'\\)"
    - from: "dashboard/src/app/(dashboard)/accounts/[id]/page.tsx"
      to: "supabase.from('balance_snapshots')"
      via: "server-side fetch for balance chart"
      pattern: "from\\('balance_snapshots'\\)"
    - from: "dashboard/src/components/charts/spend-chart.tsx"
      to: "dashboard/src/lib/format.ts"
      via: "parseNumeric for chart data transformation"
      pattern: "parseNumeric"
    - from: "dashboard/src/components/pipeline/pipeline-table.tsx"
      to: "dashboard/src/hooks/use-realtime.ts"
      via: "real-time pipeline run updates"
      pattern: "useRealtime.*pipeline_runs"
---

<objective>
Build the account detail page with spend/balance charts (R4.3, R4.10) and the pipeline health monitoring page (R4.7) with real-time updates.

Purpose: The account detail page provides drill-down visibility into individual account performance with time-series visualizations. The pipeline health page enables monitoring of data ingestion workflow reliability. Together they complete the dashboard's core feature set.

Output: Working /accounts/[id] detail page with Recharts visualizations and /pipeline health page with real-time run table.
</objective>

<execution_context>
@C:/Users/hossa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hossa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-mvp-nextjs/03-RESEARCH.md
@.planning/phases/03-dashboard-mvp-nextjs/03-01-SUMMARY.md
@dashboard/src/lib/database.types.ts
@dashboard/src/lib/format.ts
@dashboard/src/hooks/use-realtime.ts
@dashboard/src/lib/supabase/server.ts
@dashboard/src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build account detail page with spend and balance charts</name>
  <files>
    dashboard/src/app/(dashboard)/accounts/[id]/page.tsx
    dashboard/src/app/(dashboard)/accounts/[id]/loading.tsx
    dashboard/src/components/charts/spend-chart.tsx
    dashboard/src/components/charts/balance-chart.tsx
    dashboard/src/components/charts/chart-wrapper.tsx
  </files>
  <action>
1. Create `dashboard/src/components/charts/chart-wrapper.tsx`:
   - `'use client'` component
   - Simple wrapper around Recharts `ResponsiveContainer`
   - Props: `{ children: React.ReactNode, height?: number }` (default height: 300)
   - The parent div MUST have a defined height (not auto) -- use `style={{ height }}` or Tailwind `h-[300px]`
   - This prevents the Recharts "0 height" bug (Pitfall 5 from research)

2. Create `dashboard/src/components/charts/spend-chart.tsx`:
   - `'use client'` component
   - Props: `{ data: SpendRecord[], currency?: string }` (default currency: 'EGP')
   - Transform data: map each SpendRecord to `{ date, displayDate, dailySpend }` where:
     - `displayDate` = `formatCairoDate(record.date, { month: 'short', day: 'numeric' })`
     - `dailySpend` = `parseNumeric(record.daily_spend)` (CRITICAL: parse string to number for Recharts)
   - Sort data by date ascending
   - Render Recharts `AreaChart` inside `ChartWrapper`:
     - `CartesianGrid` with strokeDasharray="3 3"
     - `XAxis` with dataKey="displayDate"
     - `YAxis` with tickFormatter using `formatCurrency(String(value), currency)`
     - `Tooltip` with formatter showing currency-formatted value and label "Daily Spend"
     - `Area` type="monotone" dataKey="dailySpend" with blue stroke (#2563eb) and light fill (#3b82f6 at 0.1 opacity)
   - Show "No spend data available" message if data array is empty

3. Create `dashboard/src/components/charts/balance-chart.tsx`:
   - `'use client'` component
   - Props: `{ data: BalanceSnapshot[], currency?: string }` (default currency: 'EGP')
   - Transform data: map each BalanceSnapshot to `{ capturedAt, displayDate, balance }` where:
     - `displayDate` = `formatCairoDate(record.captured_at, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })`
     - `balance` = `parseNumeric(record.balance)`
   - Sort data by captured_at ascending
   - Render Recharts `LineChart` inside `ChartWrapper`:
     - `CartesianGrid`, `XAxis` (displayDate), `YAxis` (formatCurrency)
     - `Tooltip` with currency-formatted value, label "Balance"
     - `Line` type="monotone" dataKey="balance" with green stroke (#16a34a), no dots for cleaner line

4. Create `dashboard/src/app/(dashboard)/accounts/[id]/page.tsx`:
   - Server component
   - Auth check with `getClaims()` -- redirect if not authenticated
   - Extract `id` from params (Next.js 15 dynamic route: `{ params: Promise<{ id: string }> }`)
   - Fetch data in parallel with `Promise.all()` to avoid sequential waterfall (Pitfall 6 from research):
     ```
     const [accountResult, spendResult, balanceResult, alertsResult] = await Promise.all([
       supabase.from('ad_accounts').select('*, platforms(display_name)').eq('id', id).single(),
       supabase.from('spend_records').select('*').eq('ad_account_id', id).order('date', { ascending: false }).limit(30),
       supabase.from('balance_snapshots').select('*').eq('ad_account_id', id).order('captured_at', { ascending: false }).limit(50),
       supabase.from('alerts').select('*').eq('ad_account_id', id).order('created_at', { ascending: false }).limit(20),
     ])
     ```
   - If account not found, call `notFound()` from next/navigation
   - Page layout using shadcn Card components and Tailwind grid:
     - **Top section**: Account header card showing account_name, platform badge, status badge, business_manager, currency, current_balance (formatted), current_daily_spend (formatted), current_mtd_spend (formatted), time-to-depletion, last_synced_at
     - **Charts section**: 2-column grid on desktop (1-col on mobile)
       - Left: "Daily Spend Trend" card with SpendChart component (last 30 days)
       - Right: "Balance History" card with BalanceChart component (last 50 snapshots)
     - **Alert History section**: Card with a simple table showing recent alerts:
       - Columns: Severity (badge, color-coded), Title, Message (truncated to 100 chars), Date (Cairo timezone)
       - Show "No alerts for this account" if empty
     - **Funding Source section**: Card showing `metadata` field from ad_account if it contains funding_source info (display as JSON key-value pairs). Show "No funding source data" if metadata is empty or doesn't contain funding info.

5. Create `dashboard/src/app/(dashboard)/accounts/[id]/loading.tsx`:
   - Skeleton layout matching the detail page structure
   - Header card skeleton + two chart card skeletons + alert table skeleton

IMPORTANT:
- All dates MUST use `formatCairoDate()` with `timeZone: 'Africa/Cairo'` to prevent hydration mismatches (Pitfall 4)
- All financial values MUST go through `parseNumeric()` before Recharts (Pitfall 3)
- Charts MUST be wrapped in ChartWrapper/ResponsiveContainer with explicit height (Pitfall 5)
- Use `Promise.all()` for parallel queries (Pitfall 6)
  </action>
  <verify>
- `cd dashboard && npx tsc --noEmit` passes
- `cd dashboard && npm run build` succeeds
- Verify `accounts/[id]/page.tsx` uses `Promise.all()` for parallel data fetching
- Verify `spend-chart.tsx` calls `parseNumeric()` on `daily_spend` before charting
- Verify `balance-chart.tsx` calls `parseNumeric()` on `balance` before charting
- Verify both charts use `ChartWrapper` (or `ResponsiveContainer` with explicit height)
  </verify>
  <done>
Account detail page fetches spend_records (30 days), balance_snapshots (50), and alerts (20) in parallel. SpendChart renders daily spend as an area chart with EGP formatting. BalanceChart renders balance history as a line chart. Alert history table shows recent alerts with severity badges. Account header shows all key metrics. All financial values parsed correctly, all dates use Cairo timezone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build pipeline health monitoring page with real-time updates</name>
  <files>
    dashboard/src/app/(dashboard)/pipeline/page.tsx
    dashboard/src/app/(dashboard)/pipeline/loading.tsx
    dashboard/src/components/pipeline/pipeline-table.tsx
  </files>
  <action>
1. Create `dashboard/src/app/(dashboard)/pipeline/page.tsx`:
   - Server component
   - Auth check with `getClaims()` -- redirect if not authenticated
   - Fetch recent pipeline runs:
     ```
     supabase.from('pipeline_runs')
       .select('*')
       .order('started_at', { ascending: false })
       .limit(50)
     ```
   - RLS scopes to user's org automatically
   - Pass `initialData` to `PipelineTable` client component
   - Page title: "Pipeline Health"

2. Create `dashboard/src/components/pipeline/pipeline-table.tsx`:
   - `'use client'` component
   - Props: `{ initialData: PipelineRun[] }`
   - Manages `runs` state initialized from `initialData`
   - Subscribes to Realtime updates on `pipeline_runs` table:
     ```
     useRealtime<PipelineRun>({
       table: 'pipeline_runs',
       onInsert: useCallback((inserted) => {
         setRuns(prev => [inserted, ...prev].slice(0, 50))
       }, []),
       onUpdate: useCallback(({ new: updated }) => {
         setRuns(prev => prev.map(r => r.id === updated.id ? { ...r, ...updated } : r))
       }, []),
     })
     ```
   - Render a shadcn Table (not TanStack -- simpler table is fine here, no sorting/filtering needed):

   Columns:
   a. **Pipeline Name** (`pipeline_name`): Plain text
   b. **Status** (`status`): Badge with color coding:
      - `running` -> blue/outline
      - `success` -> green
      - `failed` -> red/destructive
      - `partial` -> yellow/secondary
   c. **Started At** (`started_at`): Format with `formatCairoDate(value, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })`
   d. **Completed At** (`completed_at`): Same formatting, show "--" if null (still running)
   e. **Duration**: Calculate `completed_at - started_at` in seconds/minutes. Show "--" if not completed.
   f. **Processed** (`accounts_processed`): Number or "--" if null
   g. **Failed** (`accounts_failed`): Number with red text if > 0, "--" if null
   h. **Errors**: If `error_log` is not null and not empty, show a "View" button in a Dialog that displays the JSON error log formatted. Otherwise show "--".

   - Add summary stats above the table:
     - Total runs in last 24h (count from data)
     - Success rate (success / total * 100)
     - Last successful run time (find most recent success, formatRelativeTime)
     - Total accounts failed in last 24h

   - Use shadcn Card for the summary stats row (4 cards in a grid: 4-col desktop, 2-col mobile)

3. Create `dashboard/src/app/(dashboard)/pipeline/loading.tsx`:
   - Skeleton: 4 stat cards at top + skeleton table rows

RESPONSIVE DESIGN:
- Stats cards: 2-col grid on mobile, 4-col on desktop
- Table: horizontal scroll on mobile
  </action>
  <verify>
- `cd dashboard && npx tsc --noEmit` passes
- `cd dashboard && npm run build` succeeds
- Verify `pipeline-table.tsx` uses `useRealtime` with table: 'pipeline_runs'
- Verify pipeline page uses `getClaims()` for auth
- Verify status badges have appropriate color coding
  </verify>
  <done>
Pipeline health page shows the last 50 workflow runs with status, timing, processed/failed counts, and error details. Summary stats at top show 24h totals and success rate. Real-time updates via Supabase Realtime ensure new pipeline runs appear immediately as they start and complete. Duration calculated from start/complete timestamps. Error logs viewable in a dialog for failed runs.
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` -- production build succeeds
2. Navigate to /accounts/{valid-id} -- see account header, charts, alert history
3. Spend chart renders daily spend data as area chart with formatted EGP axis
4. Balance chart renders balance history as line chart
5. Alert history shows severity-colored badges and Cairo-timezone dates
6. Navigate to /pipeline -- see summary stats and recent pipeline runs
7. Pipeline runs show correct status badges, timing, and processed/failed counts
8. Error dialog opens when clicking "View" on a failed run with error_log
</verification>

<success_criteria>
- /accounts/[id] renders with all R4.3 elements: spend trend chart, balance history chart, funding source info, alert history
- Charts use Recharts with proper ResponsiveContainer, parsed numeric values, Cairo timezone dates (R4.10)
- /pipeline renders with R4.7 elements: run history table, last run time, error counts
- Pipeline table updates in real-time when new runs appear or existing runs change status
- All pages are responsive (desktop/mobile) per R4.8
- Parallel data fetching keeps detail page fast (R4 success criteria: <3s load)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-mvp-nextjs/03-03-SUMMARY.md`
</output>
