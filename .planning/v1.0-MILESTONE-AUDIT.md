# Milestone 1 Audit: MVP Platform

**Audit Date:** 2026-02-12
**Milestone:** MVP Platform (Milestone 1)
**Status:** GAPS FOUND

---

## Executive Summary

Milestone 1 (MVP Platform) is **46% complete** at the code level. Phases 0-2 have been executed (security fixes, database schema, n8n pipeline workflows), while Phases 3-4 are fully planned but have zero code artifacts. Phase 5 (WhatsApp) is deferred to v1.1 and has no plans.

Cross-phase integration design is **well-architected** -- all 30+ integration checks pass with consistent table names, column names, type definitions, roles, and timezone handling. However, **1 critical defect** in the core schema migration (forward-reference FK bug) must be fixed before any fresh database deployment.

---

## Phase Status Summary

| Phase | Name | Plans | Executed | Code Artifacts | Status |
|-------|------|-------|----------|----------------|--------|
| 0 | Emergency Security Fixes | 0 (manual) | Partial | Redacted workflow JSONs | **Partial** |
| 1 | Database Foundation | 1 | 1 | 4 SQL migrations, 2 TS libs, 1 migration script | **Complete** |
| 2 | n8n Pipeline Consolidation | 3 | 3 | 5 workflow JSONs, 1 README | **Complete** |
| 3 | Dashboard MVP | 4 | 0 | None | **Planned** |
| 4 | Alert Engine | 5 | 0 | None | **Planned** |
| 5 | WhatsApp Integration | 0 | 0 | None | **Deferred (v1.1)** |

**Plans Total:** 13 created, 4 executed (31%)
**Phases Total:** 6 defined, 2 fully complete, 1 partially complete

---

## Requirements Coverage Matrix

### R1: Security & Credential Management

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R1.1 | API tokens in n8n credential store | P0 | **Partial** | Workflow JSONs reference credentials by name, but live rotation not confirmed |
| R1.2 | TikTok tokens rotated | P0 | **Pending** | Tokens redacted in JSON files; live rotation is a manual external action |
| R1.3 | Service role key not in client code | P1 | **Done** | `lib/supabase.ts` uses `NEXT_PUBLIC_SUPABASE_ANON_KEY`; service role only in `.env.local` |
| R1.4 | Env vars for all secrets | P3, P4 | **Planned** | `.env.local.example` exists; dashboard plans specify env vars |
| R1.5 | Facebook token type verified | P0 | **Pending** | Manual external action, not confirmed |

**Coverage: 2/5 done, 2/5 pending manual action, 1/5 planned**

### R2: Database Foundation

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R2.1 | Normalized schema (10+ tables) | P1 | **Done** | 11 tables in `20260212000001_create_core_schema.sql` |
| R2.2 | org_id on all tables | P1 | **Done** | All tables have `org_id UUID NOT NULL REFERENCES organizations(id)` |
| R2.3 | RLS before Realtime | P1 | **Done** | RLS in migration 000002; Realtime migration planned in P3 (later timestamp) |
| R2.4 | Auth with admin/manager/viewer | P1 | **Done** | Role CHECK constraint + JWT claim trigger in migration 000004 |
| R2.5 | DB triggers for alert evaluation | P4 | **Planned** | Specified in 04-01-PLAN.md, pg_net triggers |
| R2.6 | Denormalized current_* fields | P1 | **Done** | Triggers in migration 000003 update ad_accounts on INSERT |
| R2.7 | Data migration script | P1 | **Done** | `scripts/migrate_legacy_data.ts` with dry-run mode |
| R2.8 | UTC storage, Cairo display | P1, P2 | **Done** | TIMESTAMPTZ columns (UTC); Luxon `Africa/Cairo` in workflows; `Intl.DateTimeFormat` planned for dashboard |

**Coverage: 7/8 done, 1/8 planned**

### R3: n8n Pipeline Consolidation

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R3.1 | 8 workflows → 4 (+1 error handler) | P2 | **Done** | 5 JSONs: controller, facebook-ingestion, tiktok-1, tiktok-2, error-handler |
| R3.2 | Facebook API v23.0 | P2 | **Done** | `graph.facebook.com/v23.0/` in facebook-ingestion.json |
| R3.3 | Error logging to pipeline_runs | P2 | **Done** | All workflows log to pipeline_runs with status/error_log |
| R3.4 | No Google Sheets writes | P2 | **Done** | Zero Google Sheets references in any workflow JSON |
| R3.5 | Cairo timezone via Luxon | P2 | **Done** | All workflows use `DateTime.now().setZone('Africa/Cairo')` |
| R3.6 | Dual-write validation | P2 | **Done** | Legacy table writes exist in all ingestion workflows |
| R3.7 | Facebook balance ÷100 | P2 | **Done** | `Number(infoBody.balance) / 100` in transform node |
| R3.8 | Facebook batch API | P2 | **Done** | 50-per-batch POST requests in facebook-ingestion.json |

**Coverage: 8/8 done**

### R4: Dashboard

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R4.1 | Next.js App Router + TS strict | P3 | **Planned** | 03-01-PLAN.md Task 1 |
| R4.2 | Unified account overview | P3 | **Planned** | 03-02-PLAN.md |
| R4.3 | Account detail with charts | P3 | **Planned** | 03-03-PLAN.md Task 1 |
| R4.4 | Platform/status/BM filters | P3 | **Planned** | 03-02-PLAN.md Task 2 |
| R4.5 | Realtime live updates | P3 | **Planned** | 03-01-PLAN.md Task 3 + 03-02-PLAN.md |
| R4.6 | Auth login with roles | P3 | **Planned** | 03-01-PLAN.md Task 2 |
| R4.7 | Pipeline health page | P3 | **Planned** | 03-03-PLAN.md Task 2 |
| R4.8 | Responsive design | P3 | **Planned** | 03-01-PLAN.md (mobile-nav component) |
| R4.9 | shadcn/ui + Tailwind | P3 | **Planned** | 03-01-PLAN.md Task 1 |
| R4.10 | Recharts visualizations | P3 | **Planned** | 03-03-PLAN.md Task 1 |

**Coverage: 0/10 done, 10/10 planned**

### R5: Alert Engine

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R5.1 | Configurable alert rules (5 types) | P4 | **Planned** | 04-01/04-02/04-03 PLANs |
| R5.2 | Email + Telegram delivery | P4 | **Planned** | 04-02-PLAN.md |
| R5.3 | Escalation tiers | P4 | **Planned** | 04-02-PLAN.md (escalate-alerts function) |
| R5.4 | Cooldown/deduplication | P4 | **Planned** | 04-01-PLAN.md (is_alert_in_cooldown RPC) |
| R5.5 | Alert config UI | P4 | **Planned** | 04-03-PLAN.md |
| R5.6 | Alert history + acknowledgment | P4 | **Planned** | 04-04-PLAN.md |
| R5.7 | Time-to-depletion (7-day avg) | P4 | **Planned** | 04-01-PLAN.md evaluator |
| R5.8 | Emergency bypasses quiet hours | P4 | **Planned** | 04-02-PLAN.md dispatch logic |
| R5.9 | 24/7 alerting | P4 | **Planned** | 04-01-PLAN.md (no time window) |

**Coverage: 0/9 done, 9/9 planned**

### R6: WhatsApp Integration (Deferred)

| Req | Description | Phase | Status | Evidence |
|-----|-------------|-------|--------|----------|
| R6.1 | WhatsApp Cloud API | P5 | **Deferred** | No plans created |
| R6.2 | Approved templates | P5 | **Deferred** | No plans created |
| R6.3 | Per-user opt-in | P5 | **Deferred** | No plans created |

**Coverage: 0/3, deferred to v1.1**

### Non-Functional Requirements

| NFR | Description | Status | Evidence |
|-----|-------------|--------|----------|
| NFR1 | Dashboard <3s, Realtime <5s, pipeline <15min | **Planned** | Performance criteria in Phase 3/4 plans |
| NFR2 | >99% uptime, at-least-one-channel, zero data loss | **Partial** | Dual-write + error handler provide reliability foundation |
| NFR3 | Secure credentials, RLS, no client secrets, HTTPS | **Partial** | RLS done, credential store done, HTTPS TBD |
| NFR4 | TS strict, ESLint, versioned migrations, workflow exports | **Partial** | TS strict configured, migrations versioned, workflows exported |

---

## Requirements Summary

| Group | Total | Done | Planned | Pending Manual | Deferred | Gap |
|-------|-------|------|---------|----------------|----------|-----|
| R1 Security | 5 | 2 | 1 | 2 | 0 | 0 |
| R2 Database | 8 | 7 | 1 | 0 | 0 | 0 |
| R3 Pipeline | 8 | 8 | 0 | 0 | 0 | 0 |
| R4 Dashboard | 10 | 0 | 10 | 0 | 0 | 0 |
| R5 Alerts | 9 | 0 | 9 | 0 | 0 | 0 |
| R6 WhatsApp | 3 | 0 | 0 | 0 | 3 | 0 |
| **Total** | **43** | **17** | **21** | **2** | **3** | **0** |

**All requirements are either done, planned, pending manual action, or intentionally deferred. Zero uncovered gaps.**

---

## Cross-Phase Integration Report

### Integration Check Results

| Integration Point | Checks | Pass | Fail | Status |
|-------------------|--------|------|------|--------|
| Phase 0 → Phase 1 | 3 | 3 | 0 | **PASS** |
| Phase 1 → Phase 2 | 10 | 10 | 0 | **PASS** |
| Phase 1 → Phase 3 (plan) | 7 | 7 | 0 | **PASS** |
| Phase 1 → Phase 4 (plan) | 6 | 6 | 0 | **PASS** |
| Phase 2 → Phase 3 (plan) | 3 | 3 | 0 | **PASS** |
| Phase 2 → Phase 4 (plan) | 1 | 1 | 0 | **PASS** |
| Schema Integrity | 1 | 0 | 1 | **FAIL** |
| **Total** | **31** | **30** | **1** | |

### Data Flow Completeness

All 11 database tables have both writers and readers:

| Table | Writer | Reader | Status |
|-------|--------|--------|--------|
| organizations | P1 seed | P3 layout (RLS) | Connected |
| profiles | P1 auth trigger | P3 useUser hook | Connected |
| platforms | P1 seed | P3 overview (join) | Connected |
| ad_accounts | P2 workflows (via triggers) | P3 dashboard | Connected |
| spend_records | P2 workflows | P3 charts, P4 evaluators | Connected |
| balance_snapshots | P2 workflows | P3 charts, P4 evaluators | Connected |
| pipeline_runs | P2 workflows | P3 pipeline page | Connected |
| alert_rules | P4 UI | P4 evaluate-alerts | Connected (plan) |
| alerts | P4 evaluate-alerts | P3 detail, P4 history | Connected (plan) |
| alert_deliveries | P4 dispatch | P4 detail dialog | Connected (plan) |
| notification_channels | P1 seed + P4 UI | P4 dispatch | Connected (plan) |

### Auth Protection

All 11 sensitive routes/endpoints are protected in plans. No unprotected routes found.

---

## Critical Findings

### CRITICAL: Schema Forward-Reference Bug (BLOCKS DEPLOYMENT)

**File:** `supabase/migrations/20260212000001_create_core_schema.sql`
**Issue:** `spend_records.pipeline_run_id` (line ~86) and `balance_snapshots.pipeline_run_id` (line ~104) declare `REFERENCES pipeline_runs(id)`, but the `pipeline_runs` table is not created until line ~183.
**Impact:** Migration will fail with `ERROR: relation "pipeline_runs" does not exist` on fresh database.
**Fix:** Move `CREATE TABLE pipeline_runs` above `spend_records` in the migration file.
**Severity:** BLOCKING -- must fix before any deployment.

### WARNING: TikTok token_group Metadata Not Populated

**Files:** `tiktok-ingestion-1.json`, `tiktok-ingestion-2.json`
**Issue:** Both TikTok workflows filter ad_accounts on `metadata->>token_group` = "1" or "2", but no migration or seed populates this field.
**Impact:** TikTok workflows will silently find zero accounts and produce zero data.
**Fix:** Migration script or manual seed must populate `token_group` in ad_accounts metadata for all TikTok accounts.
**Severity:** MEDIUM -- must address before TikTok workflow activation.

### INFO: Phase 0 Manual Steps Pending

Three Phase 0 items remain as manual external actions:
1. Rotate live TikTok tokens in n8n credential store
2. Rotate/verify live Facebook tokens
3. Token health-check alerting in running environment

These cannot be automated and require production access.

### INFO: ROADMAP.md Checkboxes Stale

`.planning/ROADMAP.md` shows Phase 2 plans 02-02 and 02-03 as unchecked `[ ]`, but both have been executed with summaries. The roadmap needs updating.

---

## Code Artifact Inventory

### Phase 1 Artifacts (Complete)

| File | Lines | Purpose |
|------|-------|---------|
| `supabase/migrations/20260212000001_create_core_schema.sql` | 200+ | 11 tables, indexes, constraints |
| `supabase/migrations/20260212000002_create_rls_policies.sql` | 150+ | RLS policies for all tables |
| `supabase/migrations/20260212000003_create_triggers.sql` | 80+ | Denormalized field triggers |
| `supabase/migrations/20260212000004_seed_initial_data.sql` | 90+ | Org, platforms, auth triggers |
| `scripts/migrate_legacy_data.ts` | 200+ | Legacy data migration (dry-run capable) |
| `lib/database.types.ts` | 750+ | Generated TypeScript types |
| `lib/supabase.ts` | 30+ | Typed Supabase client |

### Phase 2 Artifacts (Complete)

| File | Purpose |
|------|---------|
| `n8n-workflows/facebook-ingestion.json` | Facebook batch API ingestion (4 BMs, 1 connection) |
| `n8n-workflows/tiktok-ingestion-1.json` | TikTok ingestion (token group 1) |
| `n8n-workflows/tiktok-ingestion-2.json` | TikTok ingestion (token group 2) |
| `n8n-workflows/controller.json` | Orchestrator (3h cron, sequential sub-workflows) |
| `n8n-workflows/error-handler.json` | Stuck pipeline_run finalizer |
| `n8n-workflows/README.md` | Import guide, credential setup, architecture |

### Phase 3-5 Artifacts (None Yet)

No code artifacts exist for Phases 3-5. All are plan-only.

---

## Decisions Log (Milestone-Wide)

1. Use `npx supabase` (global install blocked upstream)
2. NUMERIC columns as strings in TypeScript types (financial precision)
3. Migration script defaults to dry-run mode
4. Dual-write until 7 discrepancy-free days
5. Controller owns scheduling -- workflow-level retries disabled
6. Sequential sub-workflow execution (not parallel) for observability
7. Stuck pipeline_runs (30+ min) treated as failed by error handler
8. Phase 5 (WhatsApp) deferred to v1.1

---

## Completion Assessment

```
Phase 0: ████████░░ 80% (redaction done, manual rotation pending)
Phase 1: ██████████ 100% (all artifacts, summary, types)
Phase 2: ██████████ 100% (all workflows, summaries, README)
Phase 3: ░░░░░░░░░░ 0% (4 plans ready, no code)
Phase 4: ░░░░░░░░░░ 0% (5 plans ready, no code)
Phase 5: ░░░░░░░░░░ 0% (deferred to v1.1)

Overall: ██████░░░░ ~46% complete (code-level)
Plans:   █████████░ 100% for Phases 0-4 (13/13 plans created)
```

---

## Routing Recommendation

**Status: `gaps_found`**

### Before Executing Phase 3:

1. **FIX CRITICAL**: Reorder `pipeline_runs` table creation in `20260212000001_create_core_schema.sql` to appear before `spend_records` and `balance_snapshots`
2. **FIX WARNING**: Add `token_group` population to the legacy migration script or create a separate seed migration for TikTok accounts
3. **UPDATE**: Fix stale ROADMAP.md checkboxes for Phase 2 plans 02-02 and 02-03

### Recommended Next Steps:

```
/gsd:execute-phase 3   (Dashboard MVP -- 4 plans, ~36 files)
```

Phase 3 is the natural next step. All its dependencies (Phase 1 schema + Phase 2 data pipeline) are complete. The 4 plans are verified and ready for execution.

After Phase 3:
```
/gsd:execute-phase 4   (Alert Engine -- 5 plans, Edge Functions + UI)
```

---

*Audit generated: 2026-02-12*
*Auditor: Claude Opus 4.6*
